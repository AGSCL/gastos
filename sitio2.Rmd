---
title: "Gastos Casa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    code_folding: hide
    theme: cosmo
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;g
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>


```{r setup, include=FALSE}
# ---
# title: "Gastos Casa"
# date: "`r format(Sys.time(), '%d %B, %Y')`"
# output:
#   fidelius::html_password_protected:
#     style:
#       button_text: "Ingresar clave"
#     password: "mapashito"
#     preview: false
#     hint: "la miaupeshito, miaupeshito..."
#     bundle: true
#     output_format: 
#       rmarkdown::html_document:
#         code_folding: hide  
#         toc: true # table of content true
#         toc_depth: 4  # upto three depths of headings (specified by #, ## and ###)
#         toc_float: true
#         theme: cosmo
# ---

rm(list=ls());gc()
unlink('SUD_CL/Duplicates_cache', recursive = TRUE)
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = TRUE)
if(!require(readr)){install.packages("readr")}
if(!require(rowr)){install.packages("rowr")}
if(!require(plyr)){install.packages("plyr")}
if(!require(fUnitRoots)){install.packages("fUnitRoots")}
if(!require(reshape2)){install.packages("reshape2")}
if(!require(tidyr)){install.packages("tidyr")}
if(!require(data.table)){install.packages("data.table")}
if(!require(DataExplorer)){install.packages("DataExplorer")}
if(!require(stringi)){install.packages("stringi")}
if(!require(stringr)){install.packages("stringr")}
if(!require(zoo)){install.packages("zoo")}
if(!require(readxl)){install.packages("readxl")}
if(!require(httr)){install.packages("httr")}

if(!require(sparklyr)){install.packages("sparklyr")}
if(!require(plotrix)){install.packages("plotrix")}
if(!require(gridExtra)){install.packages("gridExtra")}
if(!require(grid)){install.packages("grid")}
if(!require(GGally)){install.packages("GGally")}
if(!require(lattice)){install.packages("lattice")}

if(!require(sjPlot)){install.packages("sjPlot")}
if(!require(gsynth)){install.packages("gsynth")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(dplyr)){install.packages("dplyr")}
if(!require(tsibble)){install.packages("tsibble")}


if(!require(tm)){install.packages("tm")}
if(!require(SnowballC)){install.packages("SnowballC")}
if(!require(wordcloud)){install.packages("wordcloud")}
if(!require(RColorBrewer)){install.packages("RColorBrewer")}

if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(forecast)){install.packages("forecast")}
if(!require(xts)){install.packages("xts")}
if(!require(plotly)){install.packages("plotly")}
if(!require(readxl)){install.packages("readxl")}
if(!require(autoplotly)){install.packages("autoplotly")}
if(!require(sjPlot)){install.packages("sjPlot")}



require(ggplot2)
require(dplyr)
require(data.table)
require(zoo)
require(sjPlot)
require(maditr)
require(fable)
```

# 1. Gastos (cálculos antiguos)


```{r generar-base, include=F,warning=F, message=F}
path_sec<- paste0("https://docs.google.com/spreadsheets/d/",Sys.getenv("SUPERSECRET"),"/export?format=csv&id=",Sys.getenv("SUPERSECRET"),"&gid=1386184641")

Gastos_casa <- readr::read_csv(as.character(path_sec),
                col_names = c("Tiempo", "gasto", "fecha", "obs", "monto", "gastador",
                              "link"),skip=1)
```

```{r vista-preliminar, warning=F, message=F}
Gastos_casa %>% 
  dplyr::select(-Tiempo,-link) %>%
  dplyr::select(fecha, gasto, monto, gastador,obs) %>% tail(30) %>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ",", big.mark = "."),
                   caption="Tabla 1. Gastos Casa (últimos 30 registros)", align =rep('c', 3)) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
    kableExtra::scroll_box(width = "100%", height = "300px")
```


```{r head-gastos-casa, echo=FALSE, eval=F,echo=F}
head(Gastos_casa)
```


```{r fig-1, echo=FALSE, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura 1. Tipos de Gasto por Persona"}

Gastos_casa %>% 
  dplyr::mutate(gastos_mod=dplyr::case_when(gasto=="Gas"~"Gas/Bencina",
    gasto=="aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                            gasto=="Tina"~"electrodomésticos/mantención casa",
                                            gasto=="Nexium"~"Farmacia",
                                            gasto=="donaciones"~"donaciones/regalos",
                                            gasto=="Regalo chocolates"~"donaciones/regalos",
                                            gasto=="filtro piscina msp"~"electrodomésticos/mantención casa",
                                            gasto=="Chromecast"~"electrodomésticos/mantención casa",
                                            gasto=="Muebles ratan"~"electrodomésticos/mantención casa",
                                            gasto=="Vacuna Influenza"~"Farmacia",
                                            gasto=="Easy"~"electrodomésticos/mantención casa",
                                            gasto=="Sopapo"~"electrodomésticos/mantención casa",
                                            gasto=="filtro agua"~"electrodomésticos/mantención casa",
                                            gasto=="ropa tami"~"donaciones/regalos",
                                            gasto=="yaz"~"Farmacia",
                                            gasto=="Yaz"~"Farmacia",
                                            gasto=="Remedio"~"Farmacia",
                                            gasto=="Entel"~"VTR",
                                            gasto=="Kerosen"~"Gas/Bencina",
                                            gasto=="Parafina"~"Gas/Bencina",
                                            gasto=="Plata basurero"~"donaciones/regalos",
                                            gasto=="Matri Andrés Kogan"~"donaciones/regalos",
                                            gasto=="Wild Protein"~"Comida",
                                            gasto=="Granola Wild Foods"~"Comida",
                                            gasto=="uber"~"Transporte",
                                            gasto=="Uber Reñaca"~"Transporte",
                                            gasto=="filtro piscina mspa"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza Alfombra"~"electrodomésticos/mantención casa",
                                            gasto=="Aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza alfombras"~"electrodomésticos/mantención casa",
                                            gasto=="Pila estufa"~"electrodomésticos/mantención casa",
                                            gasto=="Reloj"~"electrodomésticos/mantención casa",
                                            gasto=="Arreglo"~"electrodomésticos/mantención casa",
                                            gasto=="Pan Pepperino"~"Comida",
                                            gasto=="Cookidoo"~"Comida",
                                            gasto=="remedios"~"Farmacia",
                                            gasto=="Bendina Reñaca"~"Gas/Bencina",
                                            gasto=="Bencina Reñaca"~"Gas/Bencina",
                                            gasto=="Vacunas Influenza"~"Farmacia",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                              T~gasto)) %>% 
ggplot2::ggplot(aes(x=as.factor(gastos_mod),y=as.numeric(monto))) + 
  geom_bar(stat="identity") + 
  theme_minimal() +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000," Mil")) + 
  theme(axis.text.x = element_text(angle = 45, vjust=0.5, size= 11)) +
  facet_wrap(~gastador) +
  labs(
    x = "Ítems",
    y = "Gasto (por miles)",
    title = paste(
      "Figura 1. Tipos de Gasto por Persona (TOTAL)"
    )
  ) 
```

```{r gasto-tot-por-gastador, echo=FALSE, fig.height=4, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura 2. Promedio de gasto por gastador", cache=T}

#para ver las diferencias depués de la diosi
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
    dplyr::group_by(gastador, fecha,.drop = F) %>% 
    dplyr::summarise(gasto_media=mean(monto,na.rm=T)) %>% 
    dplyr::mutate(treat=ifelse(fecha>"2019-W26",1,0)) %>%
    #dplyr::mutate(fecha_simp=lubridate::week(fecha)) %>%#después de  diosi. Junio 24, 2019	
    dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés"))) %>% 
    assign("ts_gastos_casa_week_treat", ., envir = .GlobalEnv) 

gplots::plotmeans(gasto_media ~ gastador_nombre, main="Promedio de gasto por gastador", data=ts_gastos_casa_week_treat,ylim=c(0,75000), xlab="", ylab="")

```

```{r comp_medias-por-diosi, echo=T, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura 3. Antes y Depsués de Diosi"}

par(mfrow=c(1,2)) 
gplots::plotmeans(gasto_media ~ gastador_nombre, main="Antes de Diosi", data=ts_gastos_casa_week_treat[ts_gastos_casa_week_treat$treat==0,], xlab="", ylab="", ylim=c(0,70000))

gplots::plotmeans(gasto_media ~ gastador_nombre, main="Después de Diosi", data=ts_gastos_casa_week_treat[ts_gastos_casa_week_treat$treat==1,], xlab="", ylab="",ylim=c(0,70000))

```

```{r linea-tiempo-gastador-gastos, echo=T, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F ,fig.show='hide'}
library(ggiraph)
library(scales)
#if( requireNamespace("dplyr", quietly = TRUE)){
gg <- Gastos_casa %>%
  dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
  dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
  dplyr::mutate(fecha_simp=tsibble::yearweek(fecha)) %>%
  dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
  dplyr::mutate(treat=ifelse(fecha_week>"2019 W26",1,0)) %>%
  dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés"))) %>% 
#  dplyr::mutate(week=as.Date(as.character(lubridate::floor_date(fecha, "week"))))%>%
  #dplyr::mutate(fecha_week= lubridate::parse_date_time(fecha_week, c("%Y-W%V"),exact=T)) %>% 
  dplyr::group_by(gastador_nombre, fecha_simp) %>%
  dplyr::summarise(monto_total=sum(monto)) %>%
  dplyr::mutate(tooltip= paste0(substr(gastador_nombre,1,1),"=",round(monto_total/1000,2))) %>%
  ggplot(aes(hover_css = "fill:none;")) +#, ) +
  #stat_summary(geom = "line", fun.y = median, size = 1, alpha=0.5, aes(color="blue")) +
  geom_line(aes(x = fecha_simp, y = monto_total, color=as.factor(gastador_nombre)),size=1,alpha=.5) +
                       ggiraph::geom_point_interactive(aes(x = fecha_simp, y = monto_total, color=as.factor(gastador_nombre),tooltip=tooltip),size = 1) +
  #geom_text(aes(x = fech_ing_qrt, y = perc_dup-0.05, label = paste0(n)), vjust = -1,hjust = 0, angle=45, size=3) +
 # guides(color = F)+
  sjPlot::theme_sjplot2() +
  geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
  labs(y="Gastos (en miles)",x="Semanas y Meses", subtitle="Interlineado, incorporación de la Diosi; Azul= Tami; Rojo= Andrés") + ggtitle( "Figura 4. Gastos por Gastador") +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000)) + 
  scale_color_manual(name = "Gastador", values= c("blue", "red"), labels = c("Tami", "Andrés")) +
  scale_x_yearweek(date_breaks = "1 month", minor_breaks = "1 week", labels=scales::date_format("%m/%y")) +
  theme(axis.text.x = element_text(vjust = 0.5,angle = 35), legend.position='bottom')+
     theme(
    panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_line(colour = "black")
    )

#  x <- girafe(ggobj = gg)
#  x <- girafe_options(x = x,
#                      opts_hover(css = "stroke:red;fill:orange") )
#  if( interactive() ) print(x)

#}
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"

#ggiraph(code = {print(gg)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75 )

x <- girafe(ggobj = gg)
x <- girafe_options(x,
  opts_zoom(min = 1, max = 3), opts_hover(css =tooltip_css))
```

``` {r print-linea-tiempo-gastador-gastos , echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE,caption="Figura 4. Línea de Tiempo por Gastador y Gastos"}
x
```

```{r month-gastos,echo=T,fig.align='center', echo=T, fig.pos='H', eval=T, message=FALSE, warning=F}
plot<-Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(month=as.Date(as.character(lubridate::floor_date(fecha, "month"))))%>%
    dplyr::group_by(month)%>%
    dplyr::summarise(gasto_total=sum(monto)/1000) %>%
      ggplot2::ggplot(aes(x = month, y = gasto_total)) +
      geom_point()+
      geom_line(size=1) +
      sjPlot::theme_sjplot2() +
      geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
      geom_vline(xintercept = as.Date("2019-03-23"),linetype = "dashed", color="red") +
      labs(y="Gastos (en miles)",x="Meses/Año", subtitle="Interlineado, incorporación de la Diosi") + 
      ggtitle( "Figura 5. Suma de Gastos por Mes") +        
      scale_x_date(breaks = "1 month", minor_breaks = "1 month", labels=scales::date_format("%m/%y")) +
      theme(axis.text.x = element_text(vjust = 0.5,angle = 45)) 
plotly::ggplotly(plot)  
```



```{r ts-month-gastos,echo=T,fig.align='center', echo=T, fig.pos='H', eval=T, message=FALSE, warning=F}
plot2<-Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(day)%>%
    dplyr::summarise(gasto_total=sum(monto)/1000) %>%
      ggplot2::ggplot(aes(x = day, y = gasto_total)) +
      geom_line(size=1) +
      sjPlot::theme_sjplot2() +
      geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
      geom_vline(xintercept = as.Date("2020-03-23"),linetype = "dashed", color="red") +
      labs(y="Gastos (en miles)",x="Meses/Año", subtitle="Interlineado, incorporación de la Diosi") + 
      ggtitle( "Figura 5. Suma de Gastos por Día") +        
      scale_x_date(breaks = "1 month", minor_breaks = "1 week", labels=scales::date_format("%m/%y")) +
      theme(axis.text.x = element_text(vjust = 0.5,angle = 45)) 
plotly::ggplotly(plot2)  

tsData <- Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(day)%>%
    dplyr::summarise(gasto_total=sum(monto))%>%
    dplyr::mutate(covid=case_when(day>as.Date("2019-06-02")~1,TRUE~0))%>%
    dplyr::mutate(covid=case_when(day>as.Date("2020-03-10")~covid+1,TRUE~covid))%>%
    dplyr::mutate(covid=as.factor(covid))%>%
  data.frame()

  
tsData_gastos <-ts(tsData$gasto_total, frequency=7)
mstsData_gastos <- forecast::msts(Gastos_casa$monto, seasonal.periods=c(7,30))
  tsData_gastos = decompose(tsData_gastos)
#plot(tsData_Santiago, title="Descomposición del número de casos confirmados para Santiago")
forecast::autoplot(tsData_gastos, main="Decomposición de los Gastos Diarios")+
    theme_bw()+ labs(x="Weeks")

tsdata_gastos_trend<-cbind(tsData,trend=as.vector(tsData_gastos$trend))%>% na.omit()

```

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r itsa,echo=T,fig.align='center', echo=T, fig.pos='H', eval=T, message=FALSE, warning=F}
#tsData_gastos$trend
#Using the inputted variables, a Type-2 Sum Squares ANCOVA Lagged Dependent Variable model is fitted which estimates the difference in means between interrupted and non-interrupted time periods, while accounting for the lag of the dependent variable and any further specified covariates.
#Typically such analyses use Auto-regressive Integrated Moving Average (ARIMA) models to handle the serial dependence of the residuals of a linear model, which is estimated either as part of the ARIMA process or through a standard linear regression modeling process [9,17]. All such time series methods enable the effect of the event to be separated from general trends and serial dependencies in time, thereby enabling valid statistical inferences to be made about whether an intervention has had an effect on a time series.
   #it uses Type-2 Sum Squares ANCOVA Lagged Dependent Variable model
   #ITSA model da cuenta de observaciones autocorrelacionadas e impactos dinámicos mediante una regresión de deltas en rezagados. Una vez que se incorporan en el modelo, se controlan. 
#residual autocorrelation assumptions
#TSA allows the model to account for baseline levels and trends present in the data therefore allowing us to attribute significant changes to the interruption
#RDestimate(all~agecell,data=metro_region,cutpoint = 21)

#Ver con CHANGEPOINT
##http://www.lancs.ac.uk/~killick/Pub/KillickEckley2011.pdf

itsa_metro_region_quar<-
        its.analysis::itsa.model(time = "day", depvar = "gasto_total",data=tsData,
                                 interrupt_var = "covid", 
                                 alpha = 0.05,no.plots = F, bootstrap = TRUE, Reps = 10000, print = F) 

print(itsa_metro_region_quar)
```
</div>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r itsa2,eeval=T, echo=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura 6. Gasto Mensual"}
itsa_metro_region_quar2<-
        its.analysis::itsa.model(time = "day", depvar = "trend",data=tsdata_gastos_trend,
                                 interrupt_var = "covid", 
                                 alpha = 0.05,no.plots = F, bootstrap = TRUE, Reps = 10000, print = F) 
print(itsa_metro_region_quar2)
```
</div>

Ahora con las tendencias descompuestas
 
```{r linea-tiempo-gastador-gastos-tipo, eval=T, echo=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura 7. Gasto Mensual"}
require(zoo)
require(scales)
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha2=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
    dplyr::mutate(treat=ifelse(fecha2>"2019-W26",1,0)) %>% 
   dplyr::mutate(gasto= dplyr::case_when(gasto=="Gas"~"Gas/Bencina",
    gasto=="aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                            gasto=="Tina"~"electrodomésticos/mantención casa",
                                            gasto=="Nexium"~"Farmacia",
                                            gasto=="donaciones"~"donaciones/regalos",
                                            gasto=="Regalo chocolates"~"donaciones/regalos",
                                            gasto=="filtro piscina msp"~"electrodomésticos/mantención casa",
                                            gasto=="Chromecast"~"electrodomésticos/mantención casa",
                                            gasto=="Muebles ratan"~"electrodomésticos/mantención casa",
                                            gasto=="Vacuna Influenza"~"Farmacia",
                                            gasto=="Easy"~"electrodomésticos/mantención casa",
                                            gasto=="Sopapo"~"electrodomésticos/mantención casa",
                                            gasto=="filtro agua"~"electrodomésticos/mantención casa",
                                            gasto=="ropa tami"~"donaciones/regalos",
                                            gasto=="yaz"~"Farmacia",
                                            gasto=="Yaz"~"Farmacia",
                                            gasto=="Remedio"~"Farmacia",
                                            gasto=="Entel"~"VTR",
                                            gasto=="Kerosen"~"Gas/Bencina",
                                            gasto=="Parafina"~"Gas/Bencina",
                                            gasto=="Plata basurero"~"donaciones/regalos",
                                            gasto=="Matri Andrés Kogan"~"donaciones/regalos",
                                            gasto=="Wild Protein"~"Comida",
                                            gasto=="Granola Wild Foods"~"Comida",
                                            gasto=="uber"~"Transporte",
                                            gasto=="Uber Reñaca"~"Transporte",
                                            gasto=="filtro piscina mspa"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza Alfombra"~"electrodomésticos/mantención casa",
                                            gasto=="Aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza alfombras"~"electrodomésticos/mantención casa",
                                            gasto=="Pila estufa"~"electrodomésticos/mantención casa",
                                            gasto=="Reloj"~"electrodomésticos/mantención casa",
                                            gasto=="Arreglo"~"electrodomésticos/mantención casa",
                                            gasto=="Pan Pepperino"~"Comida",
                                            gasto=="Cookidoo"~"Comida",
                                            gasto=="remedios"~"Farmacia",
                                            gasto=="Bendina Reñaca"~"Gas/Bencina",
                                            gasto=="Bencina Reñaca"~"Gas/Bencina",
                                            gasto=="Vacunas Influenza"~"Farmacia",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                        T~gasto)) %>% 
    dplyr::group_by(gastador, fecha,gasto, .drop=F) %>%
    #dplyr::mutate(fecha_simp=week(parse_date(fecha))) %>% 
#    dplyr::mutate(fecha_simp=tsibble::yearweek(fecha)) %>%#después de  diosi. Junio 24, 2019	
    dplyr::summarise(monto=sum(monto)) %>% 
    dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés"))) %>% 
  ggplot2::ggplot(aes(x = fecha, y = monto, color=as.factor(gastador_nombre))) +
  #stat_summary(geom = "line", fun.y = median, size = 1, alpha=0.5, aes(color="blue")) +
  geom_line(size=1) +
  facet_grid(gasto~.)+
  #geom_text(aes(x = fech_ing_qrt, y = perc_dup-0.05, label = paste0(n)), vjust = -1,hjust = 0, angle=45, size=3) +

  geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
  labs(y="Gastos (en miles)",x="Semanas y Meses", subtitle="Interlineado, incorporación de la Diosi; Azul= Tami; Rojo= Andrés") +
  ggtitle( "Figura 6. Gastos Semanales por Gastador e ítem (media)") +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000)) + 
  scale_color_manual(name = "Gastador", values= c("blue", "red"), labels = c("Tami", "Andrés")) +
  scale_x_yearweek(breaks = "1 month", minor_breaks = "1 week", labels=date_format("%m/%y")) +
  guides(color = F)+
  sjPlot::theme_sjplot2() +
  theme(axis.text.x = element_text(vjust = 0.5,angle = 35)) +
  theme(
    panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_line(colour = "black")
    )
```

```{r mstl, eval=T, fig.height=8, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura 8. Gasto descompuesto en Tendencias"}
autoplot(forecast::mstl(Gastos_casa$monto, lambda = "auto",iterate=5000000,start = 
lubridate::decimal_date(as.Date("2019-03-03"))))
 # scale_x_continuous(breaks = seq(0,400,by=30))
msts <- forecast::msts(Gastos_casa$monto,seasonal.periods = c(7,30.5,365.25),start = 
lubridate::decimal_date(as.Date("2019-03-03")))
#tbats <- forecast::tbats(msts,use.trend = FALSE)
#plot(tbats, main="Multiple Season Decomposition")
```


```{r tbats, eval=T, fig.height=8, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura 9. Proyección de Gasto Mensual en 2 meses más"}
library(forecast)
fit_month <- Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_month=strftime(fecha, format = "%Y-%m")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(fecha_month)%>%
     dplyr::summarise(gasto_total=sum(monto))%>%
  data.frame()

model_ets<-ets(fit_month$gasto_total, opt.crit = "mse")
#forecast::autoplot(forecast(model_ets, h = 2))

fit_tbats <- forecast::tbats(fit_month$gasto_total)
autplot<-forecast::autoplot(forecast::forecast(fit_tbats, h=2)) +
  theme_bw()
autplot
```


```{r bsts, eval=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura 11. Proyección de Gasto Semanal Pre-Post COVID, Interrupción de Tiempo"}
library(bsts)
library(CausalImpact)
ts_week_covid<-  
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(fecha_week)%>%
    dplyr::summarise(gasto_total=sum(monto,na.rm=T)/1000,min_day=min(day))%>%
    dplyr::ungroup() %>% 
    dplyr::mutate(covid=dplyr::case_when(min_day>=as.Date("2020-03-17")~1,TRUE~0))%>%
    dplyr::mutate(covid=as.factor(covid))%>%
    data.frame()


ts_week_covid$gasto_total_na<-ts_week_covid$gasto_total
post_resp<-ts_week_covid$gasto_total[which(ts_week_covid$covid==1)]
ts_week_covid$gasto_total_na[which(ts_week_covid$covid==1)]<-NA
ts_week_covid$gasto_total[which(ts_week_covid$covid==0)]

# Model 1
ssd <- list()
# Local trend, weekly-seasonal #https://qastack.mx/stats/209426/predictions-from-bsts-model-in-r-are-failing-completely - PUSE UN GENERALIZED LOCAL TREND
ssd <- AddLocalLevel(ssd, ts_week_covid$gasto_total_na) #AddSemilocalLinearTrend #AddLocalLevel
# Add weekly seasonal
ssd <- AddSeasonal(ssd, ts_week_covid$gasto_total_na,nseasons=5, season.duration = 52) #weeks OJO, ESTOS NO SON WEEKS VERDADEROS. PORQUE TENGO MAS DE EUN AÑO
ssd <- AddSeasonal(ssd, ts_week_covid$gasto_total_na, nseasons = 12, season.duration =4) #years
# For example, to add a day-of-week component to data with daily granularity, use model.args = list(nseasons = 7, season.duration = 1). To add a day-of-week component to data with hourly granularity, set model.args = list(nseasons = 7, season.duration = 24).
model1d1 <- bsts(ts_week_covid$gasto_total_na, 
               state.specification = ssd, #A list with elements created by AddLocalLinearTrend, AddSeasonal, and similar functions for adding components of state. See the help page for state.specification.
               family ="student", #A Bayesian Analysis of Time-Series Event Count Data. POISSON NO SE PUEDE OCUPAR
               niter = 20000, 
               #burn = 200, #http://finzi.psych.upenn.edu/library/bsts/html/SuggestBurn.html Suggest the size of an MCMC burn in sample as a proportion of the total run.
               seed= 2125)
#,
#               dynamic.regression=T)
#plot(model1d1, main = "Model 1")
#plot(model1d1, "components")

impact2d1 <- CausalImpact(bsts.model = model1d1,
                       post.period.response = post_resp)
plot(impact2d1)+
xlab("Date")+
  ylab("Monto Semanal (En miles)")
  
  
burn1d1 <- SuggestBurn(0.1, model1d1)

  #plot(impact3d_ratio_resp)+
  #xlab("Date")+
  #ylab("Ratio")+
  #scale_x_continuous(breaks=(c(seq(1,nrow(data15a64_rn),12),262)),
  #                   labels=as.character(unlist(data15a64_rn[c(seq(1,nrow(data15a64_rn),12),262),"date"])))+
  #theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=.5,size=11),
  #      plot.caption = element_text(hjust = 0, face= "italic",size=9))+
  ##scale_y_continuous(labels=scales::percent)+
  #labs(caption="Note. The first panel shows the data and a counterfactual prediction for the post-treatment period (Blue dashed line);\nThe second panel shows the difference between observed data and counterfactual predictions;\nThe third panel adds up the pointwise contributions from the second panel;\nBlue area= Prediction intervals.")
  
#summary(impact2d1) 
##summary(impact2d1,"report")
#msts(data15a64_rn$hosp_trauma, seasonal.periods=c(7,365.25))
```

```{r nube-de-palabras-gastos, eval=T, fig.height=4, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura 10. Nube de Palabras, Observaciones"}
corpus <- Corpus(VectorSource(Gastos_casa$obs)) # formato de texto
d  <- tm_map(corpus, tolower)
d  <- tm_map(d, stripWhitespace)
d <- tm_map(d, removePunctuation)
d <- tm_map(d, removeNumbers)
d <- tm_map(d, removeWords, stopwords("spanish"))
d <- tm_map(d, removeWords, "menos")
tdm <- TermDocumentMatrix(d)
m <- as.matrix(tdm) #lo vuelve una matriz
v <- sort(rowSums(m),decreasing=TRUE) #lo ordena y suma
df <- data.frame(word = names(v),freq=v) # lo nombra y le da formato de data.frame
#findFreqTerms(tdm)
#require(devtools)
#install_github("lchiffon/wordcloud2")
#wordcloud2::wordcloud2(v, size=1.2)
wordcloud(words = df$word, freq = df$freq, 
          max.words=100, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"), main="Figura 7. Nube de Palabras, Observaciones")
```

```{r month-gasto, echo=T,fig.align='center', fig.pos='H', eval=T, message=FALSE, warning=F}
fit_month_gasto <- Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_month=strftime(fecha, format = "%Y-%m")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
  dplyr::mutate(gasto= dplyr::case_when(gasto=="Gas"~"Gas/Bencina",
    gasto=="aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                            gasto=="Tina"~"electrodomésticos/mantención casa",
                                            gasto=="Nexium"~"Farmacia",
                                            gasto=="donaciones"~"donaciones/regalos",
                                            gasto=="Regalo chocolates"~"donaciones/regalos",
                                            gasto=="filtro piscina msp"~"electrodomésticos/mantención casa",
                                            gasto=="Chromecast"~"electrodomésticos/mantención casa",
                                            gasto=="Muebles ratan"~"electrodomésticos/mantención casa",
                                            gasto=="Vacuna Influenza"~"Farmacia",
                                            gasto=="Easy"~"electrodomésticos/mantención casa",
                                            gasto=="Sopapo"~"electrodomésticos/mantención casa",
                                            gasto=="filtro agua"~"electrodomésticos/mantención casa",
                                            gasto=="ropa tami"~"donaciones/regalos",
                                            gasto=="yaz"~"Farmacia",
                                            gasto=="Yaz"~"Farmacia",
                                            gasto=="Remedio"~"Farmacia",
                                            gasto=="Entel"~"VTR",
                                            gasto=="Kerosen"~"Gas/Bencina",
                                            gasto=="Parafina"~"Gas/Bencina",
                                            gasto=="Plata basurero"~"donaciones/regalos",
                                            gasto=="Matri Andrés Kogan"~"donaciones/regalos",
                                            gasto=="Wild Protein"~"Comida",
                                            gasto=="Granola Wild Foods"~"Comida",
                                            gasto=="uber"~"Otros",
                                            gasto=="Uber Reñaca"~"Otros",
                                            gasto=="filtro piscina mspa"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza Alfombra"~"electrodomésticos/mantención casa",
                                            gasto=="Aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza alfombras"~"electrodomésticos/mantención casa",
                                            gasto=="Pila estufa"~"electrodomésticos/mantención casa",
                                            gasto=="Reloj"~"electrodomésticos/mantención casa",
                                            gasto=="Arreglo"~"electrodomésticos/mantención casa",
                                            gasto=="Pan Pepperino"~"Comida",
                                            gasto=="Cookidoo"~"Comida",
                                            gasto=="remedios"~"Farmacia",
                                            gasto=="Bendina Reñaca"~"Gas/Bencina",
                                            gasto=="Bencina Reñaca"~"Gas/Bencina",
                                            gasto=="Vacunas Influenza"~"Farmacia",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                        T~gasto)) %>% 
  dplyr::mutate(fecha_month=factor(fecha_month, levels=format(seq(from = as.Date("2019-03-03"), to = as.Date(substr(Sys.time(),1,10)), by = "1 month"),"%Y-%m")))%>% 
  dplyr::mutate(gasto2=factor(gasto, levels=c("Agua", "Comida", "Comunicaciones","Electricidad", "Enceres", "Farmacia", "Gas/Bencina", "Diosi", "donaciones/regalos", "electrodomésticos/mantención casa", "VTR", "Netflix", "Otros")))%>% 
    dplyr::group_by(fecha_month, gasto, .drop=F)%>%
    dplyr::summarise(gasto_total=sum(monto, na.rm = T)/1000)%>%
  data.frame()

fit_month_gasto_21<-
fit_month_gasto %>% 
    #dplyr::filter()
    dplyr::filter(grepl("2021|2022",fecha_month)) %>% 
    #sacar el ultimo mes
    dplyr::filter(as.character(format(as.Date(substr(Sys.time(),1,10)),"%Y-%m"))!=fecha_month) %>% 
    dplyr::group_by(gasto) %>% 
    dplyr::summarise(gasto_prom=mean(gasto_total, na.rm=T)) %>% 
  data.frame()


fit_month_gasto_20<-
fit_month_gasto %>% 
    #dplyr::filter()
    dplyr::filter(grepl("202",fecha_month)) %>% 
    #sacar el ultimo mes
    dplyr::filter(as.character(format(as.Date(substr(Sys.time(),1,10)),"%Y-%m"))!=fecha_month) %>% 
    dplyr::group_by(gasto) %>% 
    dplyr::summarise(gasto_prom=mean(gasto_total, na.rm=T)) %>% 
  data.frame()

bind_cols(
bind_rows(fit_month_gasto_21,cbind.data.frame(gasto="Total",gasto_prom=sum(fit_month_gasto_21$gasto_prom))),
bind_rows(fit_month_gasto_20,cbind.data.frame(gasto="Total",gasto_prom=sum(fit_month_gasto_20$gasto_prom)))) %>% 
  dplyr::select(-3) %>% 
  knitr::kable(format="html", caption="Tabla. Gastos promedio por ítem a contar del...",
               col.names= c("Item","Gasto... 2021","Gasto... 2020")) %>% 
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

# 2. UF Proyectada

Saqué la UF proyectada 

```{r 1, echo=T, paged.print=TRUE,eval=T}
#options(max.print=5000)

uf18 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2018.htm")%>% rvest::html_nodes("table")
uf19 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2019.htm")%>% rvest::html_nodes("table")
uf20 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2020.htm")%>% rvest::html_nodes("table")
uf21 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2021.htm")%>% rvest::html_nodes("table")
uf22 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2022.htm")%>% rvest::html_nodes("table")

uf_serie<-
bind_rows(
cbind.data.frame(anio= 2018,uf18[[length(uf18)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1) %>%
  dplyr::mutate(value=stringr::str_trim(value), value= sub("\\.","",value)) %>% 
  dplyr::mutate(value=readr::parse_double(as.character(as.character(value)),locale=readr::locale("es", decimal_mark = ","),trim_ws = T))),

cbind.data.frame(anio= 2019, uf19[[length(uf19)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1) %>%
  dplyr::mutate(value=stringr::str_trim(value), value= sub("\\.","",value)) %>% 
  dplyr::mutate(value=readr::parse_double(as.character(as.character(value)),locale=readr::locale("es", decimal_mark = ","),trim_ws = T))),

cbind.data.frame(anio= 2020, uf20[[length(uf20)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1) %>%
  dplyr::mutate(value=stringr::str_trim(value), value= sub("\\.","",value)) %>% 
  dplyr::mutate(value=readr::parse_double(as.character(as.character(value)),locale=readr::locale("es", decimal_mark = ","),trim_ws = T))),

cbind.data.frame(anio= 2021, uf21[[length(uf21)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1) %>%
  dplyr::mutate(value=stringr::str_trim(value), value= sub("\\.","",value)) %>% 
  dplyr::mutate(value=readr::parse_double(as.character(as.character(value)),locale=readr::locale("es", decimal_mark = ","),trim_ws = T))),

cbind.data.frame(anio= 2022, uf22[[length(uf22)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1) %>%
  dplyr::mutate(value=stringr::str_trim(value), value= sub("\\.","",value)) %>% 
  dplyr::mutate(value=readr::parse_double(as.character(as.character(value)),locale=readr::locale("es", decimal_mark = ","),trim_ws = T)))
)
uf_serie_corrected<-
uf_serie %>% 
  dplyr::mutate(date=paste0(sprintf("%02d", .[[2]])," ",ifelse(tolower(.[[3]])=="sep","sept",tolower(.[[3]])),"., ",.[[1]]),date2=readr::parse_date(date, "%e %b, %Y", locale = readr::locale("es")), date3=lubridate::parse_date_time(date,c("%e %b, %Y"),exact=T)) %>% na.omit()#%>%  dplyr::filter(is.na(date3))
#Day of the month as decimal number (1–31), with a leading space for a single-digit number.
#Abbreviated month name in the current locale on this platform. (Also matches full name on input: in some locales there are no abbreviations of names.)

# 
# uf_proyectado <- readxl::read_excel("uf_proyectado.xlsx") %>% dplyr::arrange(Período) %>% 
#   dplyr::mutate(Período= as.Date(lubridate::parse_date_time(Período, c("%Y-%m-%d"),exact=T)))

ts_uf_proy<-
ts(data = uf_serie_corrected$value, 
   start = as.numeric(as.Date("2018-01-01")), 
   end = as.numeric(as.Date(uf_serie_corrected$date2[length(uf_serie_corrected$date2)])), frequency = 1,
   deltat = 1, ts.eps = getOption("ts.eps"))

fit_tbats <- forecast::tbats(ts_uf_proy)

  autoplotly::autoplotly(forecast::forecast(fit_tbats, h=298), ts.colour = "darkred",
           predict.colour = "blue", predict.linetype = "dashed")%>% 
  plotly::layout(showlegend = F, 
          yaxis = list(title = "Gastos"),
         xaxis = list(
    title="Fecha",
      ticktext = as.list(seq(from = as.Date("2018-01-01"), 
                                  to = as.Date("2018-01-01")+length(fit_tbats$fitted.values)+298, by = 90)), 
      tickvals = as.list(seq(from = as.numeric(as.Date("2018-01-01")), 
                             to = as.numeric(as.Date("2018-01-01"))+length(fit_tbats$fitted.values)+298, by = 90)),
      tickmode = "array",
    tickangle = 90
    ))
  
invisible(paste0("La proyección de la UF al ",as.Date(tail(uf_serie_corrected$date2,1)),"// ","Percentil 95% más alto proyectado: ",tail(round(as.numeric(unlist(strsplit(capture.output(forecast::forecast(fit_tbats, h=350)),"\\s{1,}"))),2),1)))
```

`r paste0("La proyección de la UF a 298 días más ",tail(uf_serie_corrected$date2,1)+298," sería de: ",format(round(as.numeric(tail(forecast::forecast(fit_tbats, h=298)$mean,1)),0),big.mark=".", decimal.mark = ","), " pesos// Percentil 95% más alto proyectado: ",suppressWarnings(format(tail(round(as.numeric(unlist(strsplit(capture.output(forecast::forecast(fit_tbats, h=350)),"\\s{1,}"))),2),1),big.mark=".", decimal.mark = ",")))`

<br>

# 3. Gastos proyectados

Lo haré en base a 2 cálculos: el gasto semanal y el gasto mensual en base a mis gastos desde marzo de 2019. La primera proyección la hice añadiendo el precio del arriendo mensual y partiendo en 2 (porque es con yo y Tami).


```{r 2, echo=T, paged.print=TRUE,eval=T}
Gastos_casa <- readr::read_csv(enlace_gastos,
                               col_names = c("Tiempo", "gasto", "fecha", "obs", "monto", "gastador",
                                             "link"),skip=1) %>% 
              dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
              dplyr::mutate(fecha_month=strftime(fecha, format = "%Y-%m")) %>%
              dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))
Gastos_casa_m <-
Gastos_casa %>% dplyr::group_by(fecha_month)%>%
              dplyr::summarise(gasto_total=(sum(monto)+500000)/1000,fecha=first(fecha))%>%
              data.frame()

fit_tbats_m <- forecast::tbats(Gastos_casa_m$gasto_total[-length(Gastos_casa_m$gasto_total)])
seq_dates<-format(seq(as.Date("2019/03/01"), by = "month", length = dim(Gastos_casa_m)[1]+12), "%m\n'%y")

autplo2t<-
  autoplotly(forecast::forecast(fit_tbats_m, h=12), ts.colour = "darkred",
           predict.colour = "blue", predict.linetype = "dashed")%>% 
  layout(showlegend = F, 
          yaxis = list(title = "Gastos"),
         xaxis = list(
    title="Fecha",
      ticktext = as.list(seq_dates[seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)]), 
      tickvals = as.list(seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)),
      tickmode = "array"#"array"
    )) 

autplo2t
```


```{r 3, echo=T, paged.print=TRUE,eval=T}
fr_fit_tbats_m<-forecast::forecast(fit_tbats_m, h=12)

```

`r paste0("Me voy a gastar esta plata (la proyección 95% más alta): ",suppressWarnings(tail(round(as.numeric(unlist(strsplit(capture.output(fr_fit_tbats_m),"\\s{1,}")))/2,2),1))," miles de pesos")`

<br>

Ahora se comparará con la proyección a nivel semanal

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:200px; overflow-x: scroll; width:100%">

```{r 4, echo=T, paged.print=TRUE,eval=T}
Gastos_casa_ts_w<-
  data.frame(date_initial=seq(from = as.Date("2019-03-03"), to = as.Date(substr(Sys.time(),1,10)), by = 1)) %>% 
  dplyr::left_join(dplyr::mutate(Gastos_casa,date=readr::parse_date(as.character(fecha), "%Y-%m-%d")), by=c("date_initial"="date")) %>% 
  dplyr::mutate(fecha=strftime(date_initial, format = "%Y-W%V")) %>% 
  dplyr::group_by(fecha) %>% 
  #Dejarlo en 1 pesos los vacíos, para que el método de estimación de lambda de Guerrero no se afecte
  dplyr::summarise(date=min(date_initial),monto=sum(ifelse(is.na(monto),1,monto))) %>% 
  dplyr::slice(-((n()-5):n()))

fit_tbats_w <- forecast::tbats(Gastos_casa_ts_w$monto)
capture.output(forecast::forecast(fit_tbats_w, h=52))
```

</div>

<br>

`r paste0("Me voy a gastar esta plata (95% proyección más alta e incluyendo gastos por arriendo): ",format(round((sum(tail(as.numeric(unlist(strsplit(capture.output(forecast::forecast(fit_tbats_w, h=52)), "\\s{1,}"))),4))+500)/2,0),big.mark=",")," pesos")`

<br>

```{r 5, eval=T, echo=T, warning=FALSE, paged.print=TRUE}
peor_escenario_uf_arancel_anual_uch<-(tail(round(as.numeric(unlist(strsplit(capture.output(forecast::forecast(fit_tbats, h=350)),"\\s{1,}"))),2),1)*105)/1000
escenario_promedio_uf_arancel_anual_uch<-(32866*105)/1000
sueldo_acc<-630
arriendo_depto<-350/2  
gastos_peor_escenario_1_mens<-tail(round(as.numeric(unlist(strsplit(capture.output(fr_fit_tbats_m),"\\s{1,}")))/2,2),1)
gastos_peor_escenario_2_sem<- round((sum(tail(as.numeric(unlist(strsplit(capture.output(forecast::forecast(fit_tbats_w, h=52)), "\\s{1,}"))),4))+500000)/2,2)/1000

#compuesto
# I= 100*0.015*12
# F=100 + I
# F
```

<br>

Añadiendo un interés compuesto de 6,75% asociado a la inflación, podría llegar a gastar `r round(gastos_peor_escenario_1_mens+gastos_peor_escenario_1_mens*0.067577*12,2)` pesos de acuerdo al peor escenario (a partir de gastos mensuales). Por otra parte, podría llegar a gastar `r round(gastos_peor_escenario_2_sem+gastos_peor_escenario_2_sem*0.067577*12,2)` (a partir de gastos semanales).

<br>

