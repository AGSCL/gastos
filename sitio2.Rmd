---
title: "Gastos Casa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    code_folding: hide
    theme: cosmo
editor_options: 
  chunk_output_type: console
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
  
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="hideOutput.js"></script> 
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {    
	$chunks = $('.fold');    
	$chunks.each(function () {      // add button to source code chunks     
	if ( $(this).hasClass('s') ) {       
		$('pre.r', this).prepend("<div class=\"showopt\">Show Source</div><br style=\"line-height:22px;\"/>");
       		$('pre.r', this).children('code').attr('class', 'folded');     
       		}      // add button to output chunks     
		if ( $(this).hasClass('o') ) {       
			$('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");       
			$('pre:not(.r)', this).children('code:not(r)').addClass('folded');        // add button to plots       
			$(this).find('img').wrap('<pre class=\"plot\"></pre>');       
			$('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");       
			$('pre.plot', this).children('img').addClass('folded');      
			}   
});    // hide all chunks when document is loaded   
	$('.folded').css('display', 'none')    // function to toggle the visibility   
	$('.showopt').click(function() {     
			var label = $(this).html();     
			if (label.indexOf("Show") >= 0) {       
				$(this).html(label.replace("Show", "Hide"));     
			} else {
			  $(this).html(label.replace("Hide", "Show"));     
			}     
	$(this).siblings('code, img').slideToggle('fast', 'swing');   
	}); 
}); 
```

```{=html}
<style type="text/css">
.showopt {   
  background-color: #004c93;   color: #FFFFFF;    width: 100px;   height: 20px;   text-align: center;   vertical-align: middle !important;   float: right;   font-family: sans-serif;   border-radius: 8px; 
  }
.showopt:hover {     
        background-color: #dfe4f2;
        color: #004c93; 
        }  
pre.plot {   
        background-color: white !important; 
        } 
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
/* https://vivekjaiskumar.medium.com/css-is-and-not-selector-17c942ec83f :is()*/
/* Applies to outputs that are not code other than R*/
pre {
  overflow-x: auto !important;
}
pre code {
  word-wrap: normal !important;
  white-space: pre !important;
}
/*
pre:not(.sourceCode) { 
  white-space: nowrap !important;
}
*/
.sourceCode { /* Important gives precedence  */
  font-size: 10px !important;
  line-height: 50% !important;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    height:350px;
    white-space: nowrap;
    overflow-x: auto; 
    width:100%;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
.message { color:#446C6E; font-family: monospace;font-size: 10px; line-height: 110%; font-weight: bold;}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 5px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 5px; text-align: justify;}
.pandoc-table { /* Should add !important; but it seems no necessary  */
  margin-left:auto; /* To center */
  margin-right:auto;
  border-collapse: collapse;
  table-layout: auto;
  font-size: 11px;
  overflow-y: auto;
  max-height:450px !important;
  white-space: nowrap;
  overflow-x: auto; 
  width:450px;
}
.pandoc-table th {/* header */
text-align: center !important;
font-size: 10px;
padding: 0px;
}
.pandoc-table td {
text-align: left !important;
font-size: 9px;
padding: 0px;
}
.pandoc-table caption {
    text-align: left !important;
    font-size: 11px !important;
}
.controlly{
    overflow-y:scroll;
    height:351px;
    overflow-x: scroll; 
}
</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->
<script>
function myFunction1() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
<script>
function myFunction2() {
    var x = document.getElementById("myDIV2");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
```
<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">

```{r setup, include=FALSE}
Sys.setlocale("LC_COLLATE", "Spanish_Chile.1252")
Sys.setlocale("LC_COLLATE", "Spanish_Chile.1252")
Sys.setlocale("LC_CTYPE", "Spanish_Chile.1252")
Sys.setlocale("LC_MONETARY", "Spanish_Chile.1252")
Sys.setlocale("LC_TIME", "Spanish_Chile.1252")
# ---
# title: "Gastos Casa"
# date: "`r format(Sys.time(), '%d %B, %Y')`"
# output:
#   fidelius::html_password_protected:
#     style:
#       button_text: "Ingresar clave"
#     password: "mapashito"
#     preview: false
#     hint: "la miaupeshito, miaupeshito..."
#     bundle: true
#     output_format: 
#       rmarkdown::html_document:
#         code_folding: hide  
#         toc: true # table of content true
#         toc_depth: 4  # upto three depths of headings (specified by #, ## and ###)
#         toc_float: true
#         theme: cosmo
# ---

rm(list=ls());gc()
unlink('SUD_CL/Duplicates_cache', recursive = TRUE)
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = TRUE)
if(!require(readr)){install.packages("readr")}
if(!require(rowr)){install.packages("rowr")}
if(!require(plyr)){install.packages("plyr")}
if(!require(fUnitRoots)){install.packages("fUnitRoots")}
if(!require(reshape2)){install.packages("reshape2")}
if(!require(data.table)){install.packages("data.table")}
if(!require(DataExplorer)){install.packages("DataExplorer")}
if(!require(stringi)){install.packages("stringi")}
if(!require(stringr)){install.packages("stringr")}
if(!require(zoo)){install.packages("zoo")}
if(!require(readxl)){install.packages("readxl")}
if(!require(httr)){install.packages("httr")}

if(!require(sparklyr)){install.packages("sparklyr")}
if(!require(plotrix)){install.packages("plotrix")}
if(!require(gridExtra)){install.packages("gridExtra")}
if(!require(grid)){install.packages("grid")}
if(!require(GGally)){install.packages("GGally")}
if(!require(lattice)){install.packages("lattice")}

if(!require(sjPlot)){install.packages("sjPlot")}
if(!require(gsynth)){install.packages("gsynth")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(tsibble)){install.packages("tsibble")}


if(!require(tm)){install.packages("tm")}
if(!require(SnowballC)){install.packages("SnowballC")}
if(!require(wordcloud)){install.packages("wordcloud")}
if(!require(RColorBrewer)){install.packages("RColorBrewer")}

if(!require(forecast)){install.packages("forecast")}
if(!require(xts)){install.packages("xts")}
if(!require(plotly)){install.packages("plotly")}
if(!require(rvest)){install.packages("rvest")}
if(!require(autoplotly)){install.packages("autoplotly")}
if(!require(janitor)){install.packages("janitor")}

if(!require(DT)){install.packages("DT")}
if(!require(tidytext)){install.packages("tidytext")}

require(ggplot2)
require(dplyr)
require(data.table)
require(zoo)
require(sjPlot)
require(maditr)

theme_custom <- function() {
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid.major = element_line(color = "grey80"),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  )
}
```

</div>

# 1. Gastos (cálculos antiguos)


```{r generar-base, include=F,warning=F, message=F}
if(nchar(Sys.getenv("SUPERSECRET"))<2){
  Sys.setenv("SUPERSECRET"=as.character(read.table("secret_key.txt", quote="\"", comment.char="")))
}
if(nchar(Sys.getenv("SUPERSECRET"))<2){
  try(Sys.setenv("SUPERSECRET"=as.character(read.table(paste0(gsub("/gastos","",dirname(rstudioapi::getActiveDocumentContext()$path)),"/secret_key.txt"), quote="\"", comment.char=""))))
}

path_sec<- paste0("https://docs.google.com/spreadsheets/d/",Sys.getenv("SUPERSECRET"),"/export?format=csv&id=",Sys.getenv("SUPERSECRET"),"&gid=1386184641")

Gastos_casa <- readr::read_csv(as.character(path_sec),
                col_names = c("Tiempo", "gasto", "fecha", "obs", "monto", "gastador",
                              "link"),skip=1)
```

::: controlly
```{r vista-preliminar, warning=F, message=F}
Gastos_casa %>% 
  dplyr::select(-Tiempo,-link) %>%
  dplyr::select(fecha, gasto, monto, gastador,obs) %>% tail(30) %>% 
  knitr::kable(format = "markdown", size=12)
```
:::


```{r head-gastos-casa, echo=FALSE, eval=F,echo=F}
head(Gastos_casa)
```


```{r fig-1, echo=FALSE, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Tipos de Gasto por Persona"}

Gastos_casa %>% 
  dplyr::mutate(gastos_mod=dplyr::case_when(gasto=="Gas"~"Gas/Bencina",
    gasto=="aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                            gasto=="Tina"~"electrodomésticos/mantención casa",
                                            gasto=="Nexium"~"Farmacia",
                                            gasto=="donaciones"~"donaciones/regalos",
                                            gasto=="Regalo chocolates"~"donaciones/regalos",
                                            gasto=="filtro piscina msp"~"electrodomésticos/mantención casa",
                                            gasto=="Chromecast"~"electrodomésticos/mantención casa",
                                            gasto=="Muebles ratan"~"electrodomésticos/mantención casa",
                                            gasto=="Vacuna Influenza"~"Farmacia",
                                            gasto=="Easy"~"electrodomésticos/mantención casa",
                                            gasto=="Sopapo"~"electrodomésticos/mantención casa",
                                            gasto=="filtro agua"~"electrodomésticos/mantención casa",
                                            gasto=="ropa tami"~"donaciones/regalos",
                                            gasto=="yaz"~"Farmacia",
                                            gasto=="Yaz"~"Farmacia",
                                            gasto=="Remedio"~"Farmacia",
                                            gasto=="Entel"~"VTR",
                                            gasto=="Kerosen"~"Gas/Bencina",
                                            gasto=="Parafina"~"Gas/Bencina",
                                            gasto=="Plata basurero"~"donaciones/regalos",
                                            gasto=="Matri Andrés Kogan"~"donaciones/regalos",
                                            gasto=="Wild Protein"~"Comida",
                                            gasto=="Granola Wild Foods"~"Comida",
                                            gasto=="uber"~"Transporte",
                                            gasto=="Uber Reñaca"~"Transporte",
                                            gasto=="filtro piscina mspa"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza Alfombra"~"electrodomésticos/mantención casa",
                                            gasto=="Aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza alfombras"~"electrodomésticos/mantención casa",
                                            gasto=="Pila estufa"~"electrodomésticos/mantención casa",
                                            gasto=="Reloj"~"electrodomésticos/mantención casa",
                                            gasto=="Arreglo"~"electrodomésticos/mantención casa",
                                            gasto=="Pan Pepperino"~"Comida",
                                            gasto=="Cookidoo"~"Comida",
                                            gasto=="remedios"~"Farmacia",
                                            gasto=="Bendina Reñaca"~"Gas/Bencina",
                                            gasto=="Bencina Reñaca"~"Gas/Bencina",
                                            gasto=="Vacunas Influenza"~"Farmacia",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                              T~gasto)) %>% 
ggplot2::ggplot(aes(x=as.factor(gastos_mod),y=as.numeric(monto))) + 
  geom_bar(stat="identity") + 
  theme_minimal() +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000," Mil")) + 
  theme(axis.text.x = element_text(angle = 45, vjust=0.5, size= 11)) +
  facet_wrap(~gastador) +
  labs(
    x = "Ítems",
    y = "Gasto (por miles)",
    title = paste(
      "Figura 1. Tipos de Gasto por Persona (TOTAL)"
    )
  ) 
```

```{r gasto-tot-por-gastador, echo=FALSE, fig.height=4, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura. Promedio de gasto por gastador", cache=T}

#para ver las diferencias depués de la diosi
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
    dplyr::group_by(gastador, fecha,.drop = F) %>% 
    dplyr::summarise(gasto_media=mean(monto,na.rm=T)) %>% 
    dplyr::mutate(treat=ifelse(fecha>"2019-W26",1,0)) %>%
    #dplyr::mutate(fecha_simp=lubridate::week(fecha)) %>%#después de  diosi. Junio 24, 2019	
    dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés"))) %>% 
    assign("ts_gastos_casa_week_treat", ., envir = .GlobalEnv) 

gplots::plotmeans(gasto_media ~ gastador_nombre, main="Promedio de gasto por gastador", data=ts_gastos_casa_week_treat,ylim=c(0,75000), xlab="", ylab="")

```

```{r comp_medias-por-diosi, echo=T, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Antes y Depsués de Diosi"}

par(mfrow=c(1,2)) 
gplots::plotmeans(gasto_media ~ gastador_nombre, main="Antes de Diosi", data=ts_gastos_casa_week_treat[ts_gastos_casa_week_treat$treat==0,], xlab="", ylab="", ylim=c(0,70000))

gplots::plotmeans(gasto_media ~ gastador_nombre, main="Después de Diosi", data=ts_gastos_casa_week_treat[ts_gastos_casa_week_treat$treat==1,], xlab="", ylab="",ylim=c(0,70000))

```

```{r linea-tiempo-gastador-gastos, echo=T, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F ,fig.show='hide'}
library(ggiraph)
library(scales)
#if( requireNamespace("dplyr", quietly = TRUE)){
gg <- Gastos_casa %>%
  dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
  dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
  dplyr::mutate(fecha_simp=tsibble::yearweek(fecha)) %>%
  dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
  dplyr::mutate(treat=ifelse(fecha_week>"2019 W26",1,0)) %>%
  dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés"))) %>% 
#  dplyr::mutate(week=as.Date(as.character(lubridate::floor_date(fecha, "week"))))%>%
  #dplyr::mutate(fecha_week= lubridate::parse_date_time(fecha_week, c("%Y-W%V"),exact=T)) %>% 
  dplyr::group_by(gastador_nombre, fecha_simp) %>%
  dplyr::summarise(monto_total=sum(monto)) %>%
  dplyr::mutate(tooltip= paste0(substr(gastador_nombre,1,1),"=",round(monto_total/1000,2))) %>%
  ggplot(aes(hover_css = "fill:none;")) +#, ) +
  #stat_summary(geom = "line", fun.y = median, size = 1, alpha=0.5, aes(color="blue")) +
  geom_line(aes(x = fecha_simp, y = monto_total, color=as.factor(gastador_nombre)),size=1,alpha=.5) +
                       ggiraph::geom_point_interactive(aes(x = fecha_simp, y = monto_total, color=as.factor(gastador_nombre),tooltip=tooltip),size = 1) +
  #geom_text(aes(x = fech_ing_qrt, y = perc_dup-0.05, label = paste0(n)), vjust = -1,hjust = 0, angle=45, size=3) +
 # guides(color = F)+
  theme_custom() +
  geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
  labs(y="Gastos (en miles)",x="Semanas y Meses", subtitle="Interlineado, incorporación de la Diosi; Azul= Tami; Rojo= Andrés") + ggtitle( "Figura 4. Gastos por Gastador") +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000)) + 
  scale_color_manual(name = "Gastador", values= c("blue", "red"), labels = c("Tami", "Andrés")) +
  scale_x_yearweek(date_breaks = "1 month", minor_breaks = "1 week", labels=scales::date_format("%m/%y")) +
  theme(axis.text.x = element_text(vjust = 0.5,angle = 35), legend.position='bottom')+
     theme(
    panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_line(colour = "black")
    )

#  x <- girafe(ggobj = gg)
#  x <- girafe_options(x = x,
#                      opts_hover(css = "stroke:red;fill:orange") )
#  if( interactive() ) print(x)

#}
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"

#ggiraph(code = {print(gg)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75 )

x <- girafe(ggobj = gg)
x <- girafe_options(x,
  opts_zoom(min = 1, max = 3), opts_hover(css =tooltip_css))
```

``` {r print-linea-tiempo-gastador-gastos , echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE,caption="Figura. Línea de Tiempo por Gastador y Gastos"}
x
```

```{r month-gastos,echo=T,fig.align='center', echo=T, fig.pos='H', eval=T, message=FALSE, warning=F}
plot<-Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(month=as.Date(as.character(lubridate::floor_date(fecha, "month"))))%>%
    dplyr::group_by(month)%>%
    dplyr::summarise(gasto_total=sum(monto)/1000) %>%
      ggplot2::ggplot(aes(x = month, y = gasto_total)) +
      geom_point()+
      geom_line(size=1) +
      theme_custom() +
      geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
      geom_vline(xintercept = as.Date("2019-03-23"),linetype = "dashed", color="red") +
      labs(y="Gastos (en miles)",x="Meses/Año", subtitle="Interlineado, incorporación de la Diosi") + 
      ggtitle( "Figura. Suma de Gastos por Mes") +        
      scale_x_date(breaks = "1 month", minor_breaks = "1 month", labels=scales::date_format("%m/%y")) +
      theme(axis.text.x = element_text(vjust = 0.5,angle = 45)) 
plotly::ggplotly(plot)  
```



```{r ts-month-gastos,echo=T,fig.align='center', echo=T, fig.pos='H', eval=T, message=FALSE, warning=F}
plot2<-Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(day)%>%
    summarise(gasto_total=sum(monto)/1000) %>%
      ggplot2::ggplot(aes(x = day, y = gasto_total)) +
      geom_line(size=1) +
      theme_custom() +
      geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
      geom_vline(xintercept = as.Date("2020-03-23"),linetype = "dashed", color="red") +
      labs(y="Gastos (en miles)",x="Meses/Año", subtitle="Interlineado, incorporación de la Diosi") + 
      ggtitle( "Figura. Suma de Gastos por Día") +        
      scale_x_date(breaks = "1 month", minor_breaks = "1 week", labels=scales::date_format("%m/%y")) +
      theme(axis.text.x = element_text(vjust = 0.5,angle = 45)) 
plotly::ggplotly(plot2)  

tsData <- Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(day)%>%
    summarise(gasto_total=sum(monto))%>%
    dplyr::mutate(covid=case_when(day>as.Date("2019-06-02")~1,TRUE~0))%>%
    dplyr::mutate(covid=case_when(day>as.Date("2020-03-10")~covid+1,TRUE~covid))%>%
    dplyr::mutate(covid=as.factor(covid))%>%
  data.frame()
```


```{r descompone_la_serie,echo=T, echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE,caption="Figura. Serie descompuesta"}

tsData_gastos <-ts(tsData$gasto_total, frequency=7)
mstsData_gastos <- forecast::msts(Gastos_casa$monto, seasonal.periods=c(7,30))

tsData_gastos = decompose(tsData_gastos)

tsdata_gastos_trend<-cbind(tsData,trend=as.vector(tsData_gastos$trend))%>% na.omit()

# Assuming your time series starts on "2019-03-03"
start_date <- as.Date("2019-03-03")
frequency <- 7  # Weekly data
num_periods <- length(tsData_gastos$x)  # Total number of periods in your time series

# Generate sequence of dates
dates <- tsData$day# seq.Date(from = start_date, by = "day", length.out = num_periods)

# Create a data frame from the decomposed time series object
tsData_gastos_df <- data.frame(
  day = dates,
  Actual = as.numeric(tsData_gastos$x),
  Seasonal = as.numeric(tsData_gastos$seasonal),
  Trend = as.numeric(tsData_gastos$trend),
  Random = as.numeric(tsData_gastos$random)
)

tsData_gastos_long <- tsData_gastos_df %>%
  pivot_longer(cols = c("Actual", "Seasonal", "Trend", "Random"), 
               names_to = "Component", values_to = "Value")

# Plotting with facet_wrap
ggplot(tsData_gastos_long, aes(x = day, y = Value)) +
  geom_line() +
  theme_bw() + 
  labs(title = "Descomposición de los Gastos Diarios", x = "Date", y = "Value") +
  scale_x_date(date_breaks = "3 months", date_labels = "%m %Y") +
  facet_wrap(~ Component, scales = "free_y", ncol=1) +
theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme(strip.text = element_text(size = 12))
```


<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r itsa2, eval=T, echo=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Gasto Mensual"}
#tsData_gastos$trend
#Using the inputted variables, a Type-2 Sum Squares ANCOVA Lagged Dependent Variable model is fitted which estimates the difference in means between interrupted and non-interrupted time periods, while accounting for the lag of the dependent variable and any further specified covariates.
#Typically such analyses use Auto-regressive Integrated Moving Average (ARIMA) models to handle the serial dependence of the residuals of a linear model, which is estimated either as part of the ARIMA process or through a standard linear regression modeling process [9,17]. All such time series methods enable the effect of the event to be separated from general trends and serial dependencies in time, thereby enabling valid statistical inferences to be made about whether an intervention has had an effect on a time series.
   #it uses Type-2 Sum Squares ANCOVA Lagged Dependent Variable model
   #ITSA model da cuenta de observaciones autocorrelacionadas e impactos dinámicos mediante una regresión de deltas en rezagados. Una vez que se incorporan en el modelo, se controlan. 
#residual autocorrelation assumptions
#TSA allows the model to account for baseline levels and trends present in the data therefore allowing us to attribute significant changes to the interruption
#RDestimate(all~agecell,data=metro_region,cutpoint = 21)
tsdata_gastos_trend<-cbind(tsData,trend=as.vector(tsData_gastos$trend))%>% na.omit()

itsa_metro_region_quar2<-
        its.analysis::itsa.model(time = "day", depvar = "trend",data=tsdata_gastos_trend,
                                 interrupt_var = "covid", 
                                 alpha = 0.05,no.plots = F, bootstrap = TRUE, Reps = 10000, print = F) 
print(itsa_metro_region_quar2)
```
</div>

Ahora con las tendencias descompuestas
 
```{r linea-tiempo-gastador-gastos-tipo, eval=T, echo=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Gasto Mensual"}

require(zoo)
require(scales)
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha2=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
    dplyr::mutate(treat=ifelse(fecha2>"2019-W26",1,0)) %>% 
    dplyr::mutate(gasto= dplyr::case_when(gasto=="Gas"~"Gas/Bencina",
                  gasto=="aspiradora"~"Electrodomésticos/mantención casa",
                  gasto=="Plata fiestas patrias basureros"~"Donaciones/regalos",
                  gasto=="Tina"~"Electrodomésticos/mantención casa",
                  gasto=="Nexium"~"Farmacia",
                  gasto=="donaciones"~"Donaciones/regalos",
                  gasto=="Regalo chocolates"~"Donaciones/regalos",
                  gasto=="filtro piscina msp"~"Electrodomésticos/mantención casa",
                  gasto=="Chromecast"~"Electrodomésticos/mantención casa",
                  gasto=="Muebles ratan"~"Electrodomésticos/mantención casa",
                  gasto=="Vacuna Influenza"~"Farmacia",
                  gasto=="Easy"~"Electrodomésticos/mantención casa",
                  gasto=="Sopapo"~"Electrodomésticos/mantención casa",
                  gasto=="filtro agua"~"Electrodomésticos/mantención casa",
                  gasto=="ropa tami"~"Donaciones/regalos",
                  gasto=="yaz"~"Farmacia",
                  gasto=="Yaz"~"Farmacia",
                  gasto=="Remedio"~"Farmacia",
                  gasto=="Entel"~"VTR",
                  gasto=="Kerosen"~"Gas/Bencina",
                  gasto=="Parafina"~"Gas/Bencina",
                  gasto=="Plata basurero"~"Donaciones/regalos",
                  gasto=="Matri Andrés Kogan"~"Donaciones/regalos",
                  gasto=="Wild Protein"~"Comida",
                  gasto=="Granola Wild Foods"~"Comida",
                  gasto=="uber"~"Transporte",
                  gasto=="Uber Reñaca"~"Transporte",
                  gasto=="filtro piscina mspa"~"Electrodomésticos/mantención casa",
                  gasto=="Limpieza Alfombra"~"Electrodomésticos/mantención casa",
                  gasto=="Aspiradora"~"Electrodomésticos/mantención casa",
                  gasto=="Limpieza alfombras"~"Electrodomésticos/mantención casa",
                  gasto=="Pila estufa"~"Electrodomésticos/mantención casa",
                  gasto=="Reloj"~"Electrodomésticos/mantención casa",
                  gasto=="Arreglo"~"Electrodomésticos/mantención casa",
                  gasto=="Pan Pepperino"~"Comida",
                  gasto=="Cookidoo"~"Comida",
                  gasto=="remedios"~"Farmacia",
                  gasto=="Bendina Reñaca"~"Gas/Bencina",
                  gasto=="Bencina Reñaca"~"Gas/Bencina",
                  gasto=="Vacunas Influenza"~"Farmacia",
                  gasto=="Remedios"~"Farmacia",
                  gasto=="Plata fiestas patrias basureros"~"Donaciones/regalos",
                  #2024
                  gasto=="cartero"~"Correo",
                  gasto=="correo"~"Correo",
                  gasto=="Gaviscón y Paracetamol"~"Farmacia",
                  gasto=="Regalo Matri Cony"~"Donaciones/regalos",
                  gasto=="Regalo Matri Chepa"~"Donaciones/regalos",
                  gasto=="Aporte Basureros"~"Donaciones/regalos",
                  gasto=="donación"~"Donaciones/regalos",
                  gasto=="Plata Reciclaje y Basurero"~"Donaciones/regalos",
                  gasto=="basureros"~"Donaciones/regalos",
                  gasto=="Microondas regalo"~"Donaciones/regalos",
                  gasto=="Cruz Verde"~"Farmacia",
                  gasto=="Remedios Covid"~"Farmacia",      
                  gasto=="nacho"~"Electrodomésticos/mantención casa",
                  gasto=="Jardinero"~"Electrodomésticos/mantención casa",
                  gasto=="mantencion toyotomi"~"Electrodomésticos/mantención casa",
                  gasto=="Cámaras Seguridad M.Barrios"~"Electrodomésticos/mantención casa",      
                  gasto=="Uber cumple papá"~"Transporte",
                  gasto=="Uber"~"Transporte",
                  gasto=="Uber Matri Cony"~"Transporte",
                  gasto=="Bencina + tag"~"Gas/Bencina",
                  gasto=="Bencina + Tag cumple Delox"~"Gas/Bencina",
                  gasto=="Bencina + peajes Maite"~"Gas/Bencina",
                  gasto=="Crunchyroll"~"Netflix",
                  gasto=="Crunchyroll"~"Netflix",
                  gasto=="Incoludido"~"Enceres",
                  gasto=="Cortina baño"~"Electrodomésticos/mantención casa",
                  gasto=="Forro cortina ducha"~"Electrodomésticos/mantención casa",
                  gasto=="Brussels"~"Comida",
                  gasto=="Tres toques"~"Enceres",
                  gasto=="Transferencia"~"Otros",
                  gasto=="prestamo"~"Otros",
                  gasto=="Préstamo Andrés"~"Otros",
                  gasto=="mouse"~"Otros",
                  gasto=="lamina"~"Otros",
      T~gasto)) %>% 
    dplyr::group_by(gastador, fecha,gasto, .drop=F) %>%
    #dplyr::mutate(fecha_simp=week(parse_date(fecha))) %>% 
#    dplyr::mutate(fecha_simp=tsibble::yearweek(fecha)) %>%#después de  diosi. Junio 24, 2019	
    dplyr::summarise(monto=sum(monto)) %>% 
    dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés"))) %>% 
  ggplot2::ggplot(aes(x = fecha, y = monto, color=as.factor(gastador_nombre))) +
  #stat_summary(geom = "line", fun.y = median, size = 1, alpha=0.5, aes(color="blue")) +
  geom_line(size=1) +
  facet_grid(gasto~.)+
  geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
  labs(y="Gastos (en miles)",x="Semanas y Meses", subtitle="Interlineado, incorporación de la Diosi; Azul= Tami; Rojo= Andrés") +
  ggtitle( "Figura 6. Gastos Semanales por Gastador e ítem (media)") +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000)) + 
  scale_color_manual(name = "Gastador", values= c("blue", "red"), labels = c("Tami", "Andrés")) +
  scale_x_yearweek(breaks = "1 month", minor_breaks = "1 week", labels=date_format("%m/%y")) +
  guides(color = F)+
  theme_custom() +
  theme(axis.text.x = element_text(vjust = 0.5,angle = 35)) +
  theme(
    panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_line(colour = "black")
    )
```

```{r mstl, eval=T, fig.height=8, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura. Gasto descompuesto en Tendencias"}
# Apply MSTL decomposition
mstl_data_autplt <- forecast::mstl(Gastos_casa$monto, lambda = "auto",iterate=5000000,start = 
lubridate::decimal_date(as.Date("2019-03-03")))

# Convert the decomposed time series to a data frame
mstl_df <- data.frame(
  Date = as.Date(Gastos_casa$fecha, format="%d/%m/%Y"),
  Data = as.numeric(mstl_data_autplt[, "Data"]),
  Trend = as.numeric(mstl_data_autplt[, "Trend"]),
  Remainder = as.numeric(mstl_data_autplt[, "Remainder"])
)

# Reshape the data frame for ggplot2
mstl_long <- mstl_df %>%
  pivot_longer(cols = -Date, names_to = "Component", values_to = "Value")

# Plotting with ggplot2
ggplot(mstl_long, aes(x = Date, y = Value)) +
  geom_line() +
  theme_bw() + 
  labs(title = "Descomposición MSTL", x = "Fecha", y = "Valor") +
  scale_x_date(date_breaks = "3 months", date_labels = "%m-%Y") +
  facet_wrap(~ Component, scales = "free_y", ncol = 1) +
  theme(strip.text = element_text(size = 12),
        axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r bsts, eval=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Proyección de Gasto Semanal Pre-Post COVID, Interrupción de Tiempo"}
library(bsts)
library(CausalImpact)
ts_week_covid<-  
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(fecha_week)%>%
    dplyr::summarise(gasto_total=sum(monto,na.rm=T)/1000,min_day=min(day))%>%
    dplyr::ungroup() %>% 
    dplyr::mutate(covid=dplyr::case_when(min_day>=as.Date("2020-03-17")~1,TRUE~0))%>%
    dplyr::mutate(covid=as.factor(covid))%>%
    data.frame()


ts_week_covid$gasto_total_na<-ts_week_covid$gasto_total
post_resp<-ts_week_covid$gasto_total[which(ts_week_covid$covid==1)]
ts_week_covid$gasto_total_na[which(ts_week_covid$covid==1)]<-NA
ts_week_covid$gasto_total[which(ts_week_covid$covid==0)]

# Model 1
ssd <- list()
# Local trend, weekly-seasonal #https://qastack.mx/stats/209426/predictions-from-bsts-model-in-r-are-failing-completely - PUSE UN GENERALIZED LOCAL TREND
ssd <- AddLocalLevel(ssd, ts_week_covid$gasto_total_na) #AddSemilocalLinearTrend #AddLocalLevel
# Add weekly seasonal
ssd <- AddSeasonal(ssd, ts_week_covid$gasto_total_na,nseasons=5, season.duration = 52) #weeks OJO, ESTOS NO SON WEEKS VERDADEROS. PORQUE TENGO MAS DE EUN AÑO
ssd <- AddSeasonal(ssd, ts_week_covid$gasto_total_na, nseasons = 12, season.duration =4) #years
# For example, to add a day-of-week component to data with daily granularity, use model.args = list(nseasons = 7, season.duration = 1). To add a day-of-week component to data with hourly granularity, set model.args = list(nseasons = 7, season.duration = 24).
model1d1 <- bsts(ts_week_covid$gasto_total_na, 
               state.specification = ssd, #A list with elements created by AddLocalLinearTrend, AddSeasonal, and similar functions for adding components of state. See the help page for state.specification.
               family ="student", #A Bayesian Analysis of Time-Series Event Count Data. POISSON NO SE PUEDE OCUPAR
               niter = 20000, 
               #burn = 200, #http://finzi.psych.upenn.edu/library/bsts/html/SuggestBurn.html Suggest the size of an MCMC burn in sample as a proportion of the total run.
               seed= 2125)
#,
#               dynamic.regression=T)
#plot(model1d1, main = "Model 1")
#plot(model1d1, "components")

impact2d1 <- CausalImpact(bsts.model = model1d1,
                       post.period.response = post_resp)
plot(impact2d1)+
xlab("Date")+
  ylab("Monto Semanal (En miles)")
  
  
burn1d1 <- SuggestBurn(0.1, model1d1)

```

```{r nube-de-palabras-gastos, eval=T, fig.height=4, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura 10. Nube de Palabras, Observaciones"}
corpus <- Corpus(VectorSource(Gastos_casa$obs)) # formato de texto
d  <- tm_map(corpus, tolower)
d  <- tm_map(d, stripWhitespace)
d <- tm_map(d, removePunctuation)
d <- tm_map(d, removeNumbers)
d <- tm_map(d, removeWords, stopwords("spanish"))
d <- tm_map(d, removeWords, "menos")
tdm <- TermDocumentMatrix(d)
m <- as.matrix(tdm) #lo vuelve una matriz
v <- sort(rowSums(m),decreasing=TRUE) #lo ordena y suma
df <- data.frame(word = names(v),freq=v) # lo nombra y le da formato de data.frame
#findFreqTerms(tdm)
#require(devtools)
#install_github("lchiffon/wordcloud2")
#wordcloud2::wordcloud2(v, size=1.2)
wordcloud(words = df$word, freq = df$freq, 
          max.words=100, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"), main="Figura 7. Nube de Palabras, Observaciones")
```

::: controlly
```{r month-gasto-recategorizar, echo=T,fig.align='center', fig.pos='H', eval=T, message=FALSE, warning=F}
fit_month_gasto <- Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_month=strftime(fecha, format = "%Y-%m")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::mutate(gasto2= dplyr::case_when(gasto=="Gas"~"Gas/Bencina",
                  gasto=="aspiradora"~"Electrodomésticos/mantención casa",
                  gasto=="Plata fiestas patrias basureros"~"Donaciones/regalos",
                  gasto=="Tina"~"Electrodomésticos/mantención casa",
                  gasto=="Nexium"~"Farmacia",
                  gasto=="donaciones"~"Donaciones/regalos",
                  gasto=="Regalo chocolates"~"Donaciones/regalos",
                  gasto=="filtro piscina msp"~"Electrodomésticos/mantención casa",
                  gasto=="Chromecast"~"Electrodomésticos/mantención casa",
                  gasto=="Muebles ratan"~"Electrodomésticos/mantención casa",
                  gasto=="Vacuna Influenza"~"Farmacia",
                  gasto=="Easy"~"Electrodomésticos/mantención casa",
                  gasto=="Sopapo"~"Electrodomésticos/mantención casa",
                  gasto=="filtro agua"~"Electrodomésticos/mantención casa",
                  gasto=="ropa tami"~"Donaciones/regalos",
                  gasto=="yaz"~"Farmacia",
                  gasto=="Yaz"~"Farmacia",
                  gasto=="Remedio"~"Farmacia",
                  gasto=="Entel"~"VTR",
                  gasto=="Kerosen"~"Gas/Bencina",
                  gasto=="Parafina"~"Gas/Bencina",
                  gasto=="Plata basurero"~"Donaciones/regalos",
                  gasto=="Matri Andrés Kogan"~"Donaciones/regalos",
                  gasto=="Wild Protein"~"Comida",
                  gasto=="Granola Wild Foods"~"Comida",
                  gasto=="uber"~"Transporte",
                  gasto=="Uber Reñaca"~"Transporte",
                  gasto=="filtro piscina mspa"~"Electrodomésticos/mantención casa",
                  gasto=="Limpieza Alfombra"~"Electrodomésticos/mantención casa",
                  gasto=="Aspiradora"~"Electrodomésticos/mantención casa",
                  gasto=="Limpieza alfombras"~"Electrodomésticos/mantención casa",
                  gasto=="Pila estufa"~"Electrodomésticos/mantención casa",
                  gasto=="Reloj"~"Electrodomésticos/mantención casa",
                  gasto=="Arreglo"~"Electrodomésticos/mantención casa",
                  gasto=="Pan Pepperino"~"Comida",
                  gasto=="Cookidoo"~"Comida",
                  gasto=="remedios"~"Farmacia",
                  gasto=="Bendina Reñaca"~"Gas/Bencina",
                  gasto=="Bencina Reñaca"~"Gas/Bencina",
                  gasto=="Vacunas Influenza"~"Farmacia",
                  gasto=="Remedios"~"Farmacia",
                  gasto=="Plata fiestas patrias basureros"~"Donaciones/regalos",
                  #2024
                  gasto=="cartero"~"Correo",
                  gasto=="correo"~"Correo",
                  gasto=="Gaviscón y Paracetamol"~"Farmacia",
                  gasto=="Regalo Matri Cony"~"Donaciones/regalos",
                  gasto=="Regalo Matri Chepa"~"Donaciones/regalos",
                  gasto=="Aporte Basureros"~"Donaciones/regalos",
                  gasto=="donación"~"Donaciones/regalos",
                  gasto=="Plata Reciclaje y Basurero"~"Donaciones/regalos",
                  gasto=="basureros"~"Donaciones/regalos",
                  gasto=="Microondas regalo"~"Donaciones/regalos",
                  gasto=="Cruz Verde"~"Farmacia",
                  gasto=="Remedios Covid"~"Farmacia",      
                  gasto=="nacho"~"Electrodomésticos/mantención casa",
                  gasto=="Jardinero"~"Electrodomésticos/mantención casa",
                  gasto=="mantencion toyotomi"~"Electrodomésticos/mantención casa",
                  gasto=="Cámaras Seguridad M.Barrios"~"Electrodomésticos/mantención casa",      
                  gasto=="Uber cumple papá"~"Transporte",
                  gasto=="Uber"~"Transporte",
                  gasto=="Uber Matri Cony"~"Transporte",
                  gasto=="Bencina + tag"~"Gas/Bencina",
                  gasto=="Bencina + Tag cumple Delox"~"Gas/Bencina",
                  gasto=="Bencina + peajes Maite"~"Gas/Bencina",
                  gasto=="Crunchyroll"~"Netflix",
                  gasto=="Crunchyroll"~"Netflix",
                  gasto=="Incoludido"~"Enceres",
                  gasto=="Cortina baño"~"Electrodomésticos/mantención casa",
                  gasto=="Forro cortina ducha"~"Electrodomésticos/mantención casa",
                  gasto=="Brussels"~"Comida",
                  gasto=="Tres toques"~"Enceres",
                  gasto=="Transferencia"~"Otros",
                  gasto=="prestamo"~"Otros",
                  gasto=="Préstamo Andrés"~"Otros",
                  gasto=="mouse"~"Otros",
                  gasto=="lamina"~"Otros",
      T~gasto)) %>% 
  dplyr::mutate(fecha_month=factor(fecha_month, levels=format(seq(from = as.Date("2019-03-03"), to = as.Date(substr(Sys.time(),1,10)), by = "1 month"),"%Y-%m")))%>% 
  dplyr::mutate(gasto2=factor(gasto2, levels=c("Agua", "Comida", "Comunicaciones","Electricidad", "Enceres", "Farmacia", "Gas/Bencina", "Diosi", "donaciones/regalos", "Electrodomésticos/ Mantención casa", "VTR", "Netflix", "Otros")))%>% 
    dplyr::group_by(fecha_month, gasto2, .drop=F)%>%
    dplyr::summarise(gasto_total=sum(monto, na.rm = T)/1000)%>%
  data.frame() %>% na.omit()

fit_month_gasto_25<-
fit_month_gasto %>% 
    #dplyr::filter()
    dplyr::filter(grepl("2025",fecha_month)) %>% 
    #sacar el ultimo mes
    dplyr::filter(as.character(format(as.Date(substr(Sys.time(),1,10)),"%Y-%m"))!=fecha_month) %>% 
    dplyr::group_by(gasto2) %>% 
    dplyr::summarise(gasto_prom=mean(gasto_total, na.rm=T)) %>% 
  data.frame()%>% ungroup()

fit_month_gasto_24<-
fit_month_gasto %>% 
    #dplyr::filter()
    dplyr::filter(grepl("2024",fecha_month)) %>% 
    #sacar el ultimo mes
    dplyr::filter(as.character(format(as.Date(substr(Sys.time(),1,10)),"%Y-%m"))!=fecha_month) %>% 
    dplyr::group_by(gasto2) %>% 
    dplyr::summarise(gasto_prom=mean(gasto_total, na.rm=T)) %>% 
  data.frame()%>% ungroup()

fit_month_gasto_23<-
fit_month_gasto %>% 
    #dplyr::filter()
    dplyr::filter(grepl("2023",fecha_month)) %>% 
    dplyr::group_by(gasto2) %>% 
    dplyr::summarise(gasto_prom=mean(gasto_total, na.rm=T)) %>% 
  data.frame()%>% ungroup()

fit_month_gasto_22<-
fit_month_gasto %>% 
    #dplyr::filter()
    dplyr::filter(grepl("2022",fecha_month)) %>% 
    dplyr::group_by(gasto2) %>% 
    dplyr::summarise(gasto_prom=mean(gasto_total, na.rm=T)) %>% 
  data.frame()%>% ungroup()

fit_month_gasto_21<-
fit_month_gasto %>% 
    #dplyr::filter()
    dplyr::filter(grepl("2021",fecha_month)) %>% 
    dplyr::group_by(gasto2) %>% 
    dplyr::summarise(gasto_prom=mean(gasto_total, na.rm=T)) %>% 
  data.frame()%>% ungroup()


fit_month_gasto_20<-
fit_month_gasto %>% 
    #dplyr::filter()
    dplyr::filter(grepl("2020",fecha_month)) %>% 
    dplyr::group_by(gasto2) %>% 
    dplyr::summarise(gasto_prom=mean(gasto_total, na.rm=T)) %>% 
  data.frame() %>% ungroup()

fit_month_gasto_25 %>% 
dplyr::right_join(fit_month_gasto_24,by="gasto2") %>%
dplyr::right_join(fit_month_gasto_23,by="gasto2") %>%
dplyr::right_join(fit_month_gasto_22,by="gasto2") %>%
dplyr::right_join(fit_month_gasto_21,by="gasto2") %>% 
dplyr::right_join(fit_month_gasto_20,by="gasto2") %>% 
  janitor::adorn_totals() %>% 
  #dplyr::select(-3)%>% 
  knitr::kable(format = "markdown", size=12, col.names= c("Item","2025","2024","2023","2022","2021","2020"))
```
:::
 

```{r month-gasto-recategorizar2, echo=FALSE}
library("tidytext")

chat <- data.frame(Gastos_casa$obs) %>%
 dplyr::mutate(count_character= nchar(Gastos_casa.obs), 
 words= nchar(gsub('[^ ]+', '',Gastos_casa.obs))+1)

#similar to chat but we are not removing the entries where author is null

to_remove <- c(stopwords(kind="spanish"), c("usted", "ahí", "aquí", "acá", 
                                              "pues", "tal", "tan", "así", "dijo", "dicen","xq","status","wnes","jaja","jajaj","tb","t","mensaje",
                                              "cómo", "sino", "entonces", "aunque", "don", "doña","nomas","si","pa","jajajaja","jjaja",
                                              "alla", "creo", "cada", "alla", "le", "el", "la", "en","weon","wea","q","jajaja","ajaja",
                                              "igual", "pasa", "pasan", "hace","manda","cacha", "multimedia","wn","po","cn","pal","ta","ajajajja", "ajajajjaja", "seee", "ajajajajja", "wajajajajajjaja", "wajajaja", "10", "1", "pq", "jajajajajajaja", "k",
                                              "toda", "ahora", "tema", "omitido", "que","Porqué","siempre","https","toy","mas","2","3",
                                              "hacen", "hacer","ajajajajaja", "jajajajajaja", "jajajajaja", "jajajajaja"))

library(stringi)

chat$text2 <- stri_replace_all_regex(chat$Gastos_casa.obs,
                                  pattern=paste0(" ",to_remove," "),
                                  replacement=rep(" ",length(to_remove)),
                                  vectorize=FALSE)

chat_clean <- chat %>%
  tidytext::unnest_tokens(word, text2) %>%
  anti_join(stop_words)


chat_clean <- chat_clean %>%
  na.omit(chat_clean)

chat_clean <- chat_clean %>%
  filter(!word %in% to_remove)

chat %>%
    tidytext::unnest_tokens(input = text2,
                  output = word) %>%
    filter(!word %in% to_remove)%>%
    count(word, sort = TRUE) %>%
    #group_by(author) %>%
    top_n(n = 20, n) %>%
    dplyr::filter(!is.na(word)) %>% 
    ggplot(aes(x = stats::reorder(word, n), y = n)) +
    geom_col(show.legend = FALSE) +
    ylab("") +
    xlab("") +
    coord_flip() +
#    facet_wrap(~author, ncol = 2, scales = "free_y") +
    scale_x_reordered() +
    ggtitle("Figura. Gastos detallados más usados")
```

<br>

# 2. UF Proyectada

Saqué la UF proyectada 

```{r 1, echo=T, paged.print=TRUE,eval=T}
#options(max.print=5000)

uf18 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2018.htm")%>% rvest::html_nodes("table")
uf19 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2019.htm")%>% rvest::html_nodes("table")
uf20 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2020.htm")%>% rvest::html_nodes("table")
uf21 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2021.htm")%>% rvest::html_nodes("table")
uf22 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2022.htm")%>% rvest::html_nodes("table")
uf23 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2023.htm")%>% rvest::html_nodes("table")
uf24 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2024.htm")%>% rvest::html_nodes("table")

tryCatch(uf25 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2025.htm")%>% rvest::html_nodes("table"),
    error = function(c) {
      uf24b <<- cbind.data.frame(Día=NA, variable=NA, value=NA)
      
    }
  )

tryCatch(uf25 <-uf25[[length(uf25)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1),
    error = function(c) {
      uf25 <<- cbind.data.frame(Día=NA, variable=NA, value=NA)
    }
)

uf_serie<-
bind_rows(
cbind.data.frame(anio= 2018, uf18[[length(uf18)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),

cbind.data.frame(anio= 2019, uf19[[length(uf19)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),

cbind.data.frame(anio= 2020, uf20[[length(uf20)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),

cbind.data.frame(anio= 2021, uf21[[length(uf21)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),

cbind.data.frame(anio= 2022, uf22[[length(uf22)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),

cbind.data.frame(anio= 2023, uf23[[length(uf23)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),

cbind.data.frame(anio= 2024, uf23[[length(uf24)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),
cbind.data.frame(anio= 2025, uf25)
)

uf_serie_corrected<-
uf_serie %>% 
dplyr::mutate(month=plyr::revalue(tolower(.[[3]]),c("ene" = 1, "feb"=2, "mar"=3, "abr"=4, "may"=5, "jun"=6, "jul"=7, "ago"=8, "sep"=9, "oct"=10, "nov"=11, "dic"=12))) %>% 
  dplyr::mutate(value=stringr::str_trim(value), value= sub("\\.","",value),value= as.numeric(sub("\\,",".",value))) %>% 
  dplyr::mutate(date=paste0(sprintf("%02d", .[[2]])," ",sprintf("%02d",as.numeric(month)),", ",.[[1]]), date3=lubridate::parse_date_time(date,c("%d %m, %Y"),exact=T),date2=date3) %>% 
   na.omit()#%>%  dplyr::filter(is.na(date3))
#Day of the month as decimal number (1–31), with a leading space for a single-digit number.
#Abbreviated month name in the current locale on this platform. (Also matches full name on input: in some locales there are no abbreviations of names.)

warning(paste0("number of observations:",nrow(uf_serie_corrected),",  min uf: ",min(uf_serie_corrected$value),",  min date: ",min(uf_serie_corrected $date3 )))

# 
# uf_proyectado <- readxl::read_excel("uf_proyectado.xlsx") %>% dplyr::arrange(Período) %>% 
#   dplyr::mutate(Período= as.Date(lubridate::parse_date_time(Período, c("%Y-%m-%d"),exact=T)))

ts_uf_proy<-
ts(data = uf_serie_corrected$value, 
   start = as.numeric(as.Date("2018-01-01")), 
   end = as.numeric(as.Date(uf_serie_corrected$date3[length(uf_serie_corrected$date3)])), frequency = 1,
   deltat = 1, ts.eps = getOption("ts.eps"))

fit_tbats <- forecast::tbats(ts_uf_proy)
	

fr_fit_tbats<-forecast::forecast(fit_tbats, h=298)

```

```{r 1-NIXTLA, echo=T, paged.print=TRUE,eval=T}
# Configurar API Key
nixtlar::nixtla_set_api_key(Sys.getenv("API_NIXTLA"))

# Preparar datos en formato requerido por TimeGPT
uf_timegpt <- uf_serie_corrected %>%
  select(ds = date3, y = value) %>%
  mutate(ds = format(ds, "%Y-%m-%d"))

# Realizar pronóstico con TimeGPT
timegpt_fcst <- nixtlar::nixtla_client_fcst(
  uf_timegpt,
  h = 298,               # 298 días a pronosticar
  freq = "D",            # Frecuencia diaria
  add_history = TRUE     # Incluir datos históricos en el output
)

# Visualizar resultados
nixtlar::nixtla_client_plot(timegpt_fcst)
```

```{r 1-5, echo=T, paged.print=TRUE,eval=T}
# Extraer pronósticos de TimeGPT
timegpt_proy <- timegpt_fcst$data %>%
  filter(type == "forecast") %>%
  select(ds, timegpt_fcst = y)

# Combinar con otras proyecciones
comparativo <- bind_rows(
  data.frame(
    ds = uf_serie_corrected$date3,
    Real = uf_serie_corrected$value
  ),
  data.frame(
    ds = as.Date(names(fr_fit_tbats$mean)),
    TBATS = as.numeric(fr_fit_tbats$mean),
    ARIMA = as.numeric(fr_fit_tbats_uf$mean)
  ) %>%
    left_join(timegpt_proy, by = "ds")
)

# Crear tabla comparativa
comparativo %>%
  tail(10) %>%
  knitr::kable(
    format = "markdown",
    col.names = c("Fecha", "Real", "TBATS", "ARIMA", "TimeGPT"),
    digits = 0,
    caption = "Comparación de pronósticos para la UF"
  )
```


`r paste0("La proyección de la UF a 298 días más ",tail(uf_serie_corrected$date2,1)+298," sería de: ",format(round(as.numeric(tail(forecast::forecast(fit_tbats, h=298)$mean,1)),0),big.mark=".", decimal.mark = ","), " pesos// Percentil 95% más alto proyectado: ",suppressWarnings(format(tail(round(as.numeric(unlist(strsplit(capture.output(forecast::forecast(fit_tbats, h=350)),"\\s{1,}"))),2),1),big.mark=".", decimal.mark = ",")))`

Ahora con un modelo ARIMA automático

<br>

```{r 1-5, echo=T, paged.print=TRUE,eval=T}
#arima_optimal_uf = forecast::auto.arima(ts_uf_proy)
#
#  autoplotly::autoplotly(forecast::forecast(arima_optimal_uf, h=298), ts.colour = "darkred",
#           predict.colour = "blue", predict.linetype = "dashed")%>% 
#  plotly::layout(showlegend = F, 
#          yaxis = list(title = "Gastos"),
#         xaxis = list(
#    title="Fecha",
#      ticktext = as.list(seq(from = as.Date("2018-01-01"), 
#                                  to = as.Date("2018-01-01")+length(fit_tbats$fitted.values)+298, by = 90)), 
#      tickvals = as.list(seq(from = as.numeric(as.Date("2018-01-01")), 
#                             to = as.numeric(as.Date("2018-01-01"))+length(fit_tbats$fitted.values)+298, by = 90)),
#      tickmode = "array",
#    tickangle = 90
#    ))
#
#fr_fit_tbats_uf<-forecast::forecast(arima_optimal_uf, h=298)
library(ggplot2)
library(dplyr)
library(tidyr)

# 1. Preparar datos históricos y pronósticos
history <- uf_serie_corrected %>% 
  select(ds = date3, Real = value)

# 2. Extraer pronósticos de todos los modelos
forecasts <- bind_rows(
  # TimeGPT
  timegpt_fcst$data %>% 
    filter(type == "forecast") %>% 
    select(ds, TimeGPT = y) %>% 
    mutate(ds = as.Date(ds)),
  
  # TBATS
  data.frame(
    ds = as.Date(as.numeric(time(ts_uf_proy)) + 298),
    TBATS = as.numeric(fr_fit_tbats$mean)
  ),
  
  # ARIMA
  data.frame(
    ds = as.Date(as.numeric(time(ts_uf_proy)) + 298),
    ARIMA = as.numeric(fr_fit_tbats_uf$mean)
  )
) %>% 
  pivot_longer(-ds, names_to = "Modelo", values_to = "Proyección")

# 3. Crear el gráfico
ggplot() +
  # Datos históricos
  geom_line(data = history, aes(x = ds, y = Real, color = "Real"), linewidth = 0.8) +
  
  # Pronósticos
  geom_line(data = forecasts, aes(x = ds, y = Proyección, color = Modelo), 
            linewidth = 0.8, linetype = "dashed") +
  
  # Intervalos de confianza de TimeGPT
  geom_ribbon(
    data = timegpt_fcst$data %>% 
      filter(type == "forecast") %>% 
      mutate(ds = as.Date(ds)),
    aes(x = ds, ymin = lo_95, ymax = hi_95),
    fill = "#4daf4a", alpha = 0.2
  ) +
  
  # Estilo y formato
  scale_color_manual(
    values = c(
      "Real" = "#377eb8",
      "TimeGPT" = "#4daf4a",
      "TBATS" = "#e41a1c",
      "ARIMA" = "#984ea3"
    )
  ) +
  labs(
    title = "Comparación de Proyecciones de UF",
    subtitle = "Modelos: TimeGPT vs TBATS vs ARIMA",
    x = "Fecha",
    y = "Valor UF",
    color = "Leyenda"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  geom_vline(
    xintercept = max(history$ds),
    linetype = "dashed",
    color = "gray50",
    linewidth = 0.6
  ) +
  annotate(
    "text",
    x = max(history$ds) - 30,
    y = max(history$Real) * 0.95,
    label = "Inicio pronósticos",
    angle = 90,
    color = "gray50",
    size = 3
  )
```

::: controlly                                                      
```{r 1-5-2, echo=T, paged.print=TRUE,eval=T}
dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats)),variable) %>% dplyr::summarise(max=max(value)) %>% 
dplyr::right_join(dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats_uf)),variable) %>% dplyr::summarise(max=max(value)),by="variable") %>% 
  dplyr::mutate(variable=factor(variable,levels=c("Lo.95","Lo.80","Point.Forecast","Hi.80","Hi.95"))) %>% 
  dplyr::arrange(variable) %>% 
  knitr::kable(format="markdown", caption="Tabla. Estimación UF (de aquí a 298 días) según cálculos de gastos mensuales",
               col.names= c("Item","UF Proyectada (TBATS)","UF Proyectada (ARIMA)"))
```
:::

<br>

# 3. Gastos proyectados

Lo haré en base a 2 cálculos: el gasto semanal y el gasto mensual en base a mis gastos desde marzo de 2019. La primera proyección la hice añadiendo el precio del arriendo mensual y partiendo en 2 (porque es con yo y Tami). No se incluye el último mes.


```{r 2, echo=T, paged.print=TRUE,eval=T , echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE,caption="Figura. Proyección de gastos (incluyendo arriendo), Modelo TBATS"}
Gastos_casa_nvo <- readr::read_csv(as.character(path_sec),
                               col_names = c("Tiempo", "gasto", "fecha", "obs", "monto", "gastador",
                                             "link"),skip=1) %>% 
              dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
              dplyr::mutate(fecha_month=strftime(fecha, format = "%Y-%m")) %>%
              dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))
Gastos_casa_m <-
Gastos_casa_nvo %>% dplyr::group_by(fecha_month)%>%
              dplyr::summarise(gasto_total=(sum(monto)+500000)/1000,fecha=first(fecha))%>%
              data.frame()

uf_serie_corrected_m <-
uf_serie_corrected %>% dplyr::mutate(ano_m=paste0(anio,"-",sprintf("%02d",as.numeric(month)))) %>%  dplyr::group_by(ano_m)%>%
              dplyr::summarise(uf=(mean(value))/1000,fecha=first(date3))%>%
              data.frame() %>% 
  dplyr::filter(fecha>="2019-02-28")
#Error: Error in standardise_path(file) : object 'enlace_gastos' not found

ts_uf_serie_corrected_m<-
ts(data = uf_serie_corrected_m$uf[-length(uf_serie_corrected_m$uf)], 
   start = 1, 
   end = nrow(uf_serie_corrected_m), 
   frequency = 1,
   deltat = 1, ts.eps = getOption("ts.eps"))

ts_gastos_casa_m<-
ts(data = Gastos_casa_m$gasto_total[-length(Gastos_casa_m$gasto_total)], 
   start = 1, 
   end = nrow(Gastos_casa_m), 
   frequency = 1,
   deltat = 1, ts.eps = getOption("ts.eps"))

fit_tbats_m <- forecast::tbats(ts_gastos_casa_m)

seq_dates<-format(seq(as.Date("2019/03/01"), by = "month", length = dim(Gastos_casa_m)[1]+12), "%m\n'%y")

autplo2t<-
  autoplotly::autoplotly(forecast::forecast(fit_tbats_m, h=12), ts.colour = "darkred",
           predict.colour = "blue", predict.linetype = "dashed")%>% 
  plotly::layout(showlegend = F, 
          yaxis = list(title = "Gastos (en miles)"),
         xaxis = list(
    title="Fecha",
      ticktext = as.list(seq_dates[seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)]), 
      tickvals = as.list(seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)),
      tickmode = "array"#"array"
    )) 

autplo2t
```

Ahora asumiendo un modelo ARIMA, e incluimos como regresor al precio de la UF.

```{r 2-5, echo=T, paged.print=TRUE,eval=T , echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE,caption="Figura. Proyección de gastos mensuales de aquí a 12 meses (incluye arriendo), Modelo ARIMA y con regresor UF promedio mensual (desde 2018)"}
paste0("Optimo pero sin regresor")
arima_optimal = forecast::auto.arima(ts_gastos_casa_m)
arima_optimal

paste0("Optimo pero con regresor")
arima_optimal2 = forecast::auto.arima(ts_gastos_casa_m, xreg=as.numeric(ts_uf_serie_corrected_m[1:(length(Gastos_casa_m$gasto_total))]))
arima_optimal2

forecast_uf<-
cbind.data.frame(fecha=as.Date(seq(as.numeric(as.Date(uf_serie_corrected$date3[length(uf_serie_corrected$date3)])),(as.numeric(as.Date(uf_serie_corrected$date3[length(uf_serie_corrected$date3)]))+299),by=1), origin = "1970-01-01"),forecast::forecast(fit_tbats, h=300)) %>% 
  dplyr::mutate(ano_m=stringr::str_extract(fecha,".{7}")) %>% 
  dplyr::group_by(ano_m)%>%
              dplyr::summarise(uf=(mean(`Hi 95`,na.rm=T))/1000,fecha=first(fecha))%>%
            data.frame()
autplo2t2<-
  autoplotly::autoplotly(forecast::forecast(arima_optimal2,xreg=c(forecast_uf$uf[1],forecast_uf$uf), h=12), ts.colour = "darkred",
           predict.colour = "blue", predict.linetype = "dashed")%>% 
  plotly::layout(showlegend = F, 
          yaxis = list(title = "Gastos (en miles)"),
         xaxis = list(
    title="Fecha",
      ticktext = as.list(seq_dates[seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)]), 
      tickvals = as.list(seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)),
      tickmode = "array"#"array"
    )) 

autplo2t2
```

::: controlly
```{r 3, echo=T, paged.print=TRUE,eval=T}
fr_fit_tbats_m<-forecast::forecast(fit_tbats_m, h=12)
fr_fit_tbats_m2<-forecast::forecast(arima_optimal, h=12)
fr_fit_tbats_m3<-forecast::forecast(arima_optimal2, h=12,xreg=c(forecast_uf$uf[1],forecast_uf$uf))

dplyr::right_join(dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats_m3)),variable) %>% dplyr::summarise(max=max(value)), dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats_m2)),variable) %>% dplyr::summarise(max=max(value)),by="variable") %>% 
dplyr::right_join(dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats_m)),variable) %>% dplyr::summarise(max=max(value)),by="variable") %>% 
  dplyr::mutate(variable=factor(variable,levels=c("Lo.95","Lo.80","Point.Forecast","Hi.80","Hi.95"))) %>% 
  dplyr::arrange(variable) %>% 
  knitr::kable(format="markdown", caption="Estimación en miles de la plata a gastar en el futuro (de aquí a 12 meses) según cálculos de gastos mensuales",
               col.names= c("Item","Modelo ARIMA con regresor (UF)","Modelo ARIMA sin regresor","Modelo TBATS")) 
```
:::

<br>

# 4. Gastos mensuales (resumen manual)

::: controlly
```{r 4, echo=T, paged.print=TRUE,eval=T}
path_sec2<- paste0("https://docs.google.com/spreadsheets/d/",Sys.getenv("SUPERSECRET"),"/export?format=csv&id=",Sys.getenv("SUPERSECRET"),"&gid=847461368")

Gastos_casa_mensual_2022 <- readr::read_csv(as.character(path_sec2),
                #col_names = c("Tiempo", "gasto", "fecha", "obs", "monto", "gastador","link"),
                skip=0)

head(Gastos_casa_mensual_2022,5) %>% 
  knitr::kable("markdown",caption="Resumen mensual, primeras 5 observaciones")
```
:::

<br>

```{r linea-tiempo-gastador-gastos-manual, eval=T, echo=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Gasto Mensual"}
(
Gastos_casa_mensual_2022 %>% 
    reshape2::melt(id.var=c("n","mes_ano")) %>%
  dplyr::mutate(gastador=as.factor(variable)) %>% 
  dplyr::select(-variable) %>% 
 ggplot2::ggplot(aes(x = n, y = value, color=gastador)) +
  scale_color_manual(name="Gastador", values=c("red", "blue"))+
  geom_line(size=1) +
  #geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
  labs(y="Gastos (en miles)",x="Meses", subtitle="Azul= Tami; Rojo= Andrés") +
  ggtitle( "Gastos Mensuales (total manual)") +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000)) + 
#  scale_color_manual(name = "Gastador", values= c("blue", "red"), labels = c("Tami", "Andrés")) +
#  scale_x_yearweek(breaks = "1 month", minor_breaks = "1 week", labels=date_format("%m/%y")) +
 # guides(color = F)+
  theme_custom() +
  theme(axis.text.x = element_text(vjust = 0.5,angle = 35)) +
  theme(
    panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_line(colour = "black")
    )
) %>% ggplotly()
```

<br>

# Session Info

```{r session_info, echo=T, paged.print=TRUE}
Sys.getenv("R_LIBS_USER")
sessionInfo()
#save.image("__analisis.RData")

sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Packages')),
      options=list(
initComplete = htmlwidgets::JS(
        "function(settings, json) {",
        "$(this.api().tables().body()).css({
            'font-family': 'Helvetica Neue',
            'font-size': '50%', 
            'code-inline-font-size': '15%', 
            'white-space': 'nowrap',
            'line-height': '0.75em',
            'min-height': '0.5em'
            });",#;
        "}")))
```
