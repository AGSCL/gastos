---
title: "Gastos Casa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    code_folding: hide
    theme: cosmo
editor_options: 
  chunk_output_type: console
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
  
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="hideOutput.js"></script> 
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {    
	$chunks = $('.fold');    
	$chunks.each(function () {      // add button to source code chunks     
	if ( $(this).hasClass('s') ) {       
		$('pre.r', this).prepend("<div class=\"showopt\">Show Source</div><br style=\"line-height:22px;\"/>");
       		$('pre.r', this).children('code').attr('class', 'folded');     
       		}      // add button to output chunks     
		if ( $(this).hasClass('o') ) {       
			$('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");       
			$('pre:not(.r)', this).children('code:not(r)').addClass('folded');        // add button to plots       
			$(this).find('img').wrap('<pre class=\"plot\"></pre>');       
			$('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");       
			$('pre.plot', this).children('img').addClass('folded');      
			}   
});    // hide all chunks when document is loaded   
	$('.folded').css('display', 'none')    // function to toggle the visibility   
	$('.showopt').click(function() {     
			var label = $(this).html();     
			if (label.indexOf("Show") >= 0) {       
				$(this).html(label.replace("Show", "Hide"));     
			} else {
			  $(this).html(label.replace("Hide", "Show"));     
			}     
	$(this).siblings('code, img').slideToggle('fast', 'swing');   
	}); 
}); 
```

```{=html}
<style type="text/css">
.showopt {   
  background-color: #004c93;   color: #FFFFFF;    width: 100px;   height: 20px;   text-align: center;   vertical-align: middle !important;   float: right;   font-family: sans-serif;   border-radius: 8px; 
  }
.showopt:hover {     
        background-color: #dfe4f2;
        color: #004c93; 
        }  
pre.plot {   
        background-color: white !important; 
        } 
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
/* https://vivekjaiskumar.medium.com/css-is-and-not-selector-17c942ec83f :is()*/
/* Applies to outputs that are not code other than R*/
pre {
  overflow-x: auto !important;
}
pre code {
  word-wrap: normal !important;
  white-space: pre !important;
}
/*
pre:not(.sourceCode) { 
  white-space: nowrap !important;
}
*/
.sourceCode { /* Important gives precedence  */
  font-size: 10px !important;
  line-height: 50% !important;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    height:350px;
    white-space: nowrap;
    overflow-x: auto; 
    width:100%;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
.message { color:#446C6E; font-family: monospace;font-size: 10px; line-height: 110%; font-weight: bold;}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 5px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 5px; text-align: justify;}
.pandoc-table { /* Should add !important; but it seems no necessary  */
  margin-left:auto; /* To center */
  margin-right:auto;
  border-collapse: collapse;
  table-layout: auto;
  font-size: 11px;
  overflow-y: auto;
  max-height:450px !important;
  white-space: nowrap;
  overflow-x: auto; 
  width:450px;
}
.pandoc-table th {/* header */
text-align: center !important;
font-size: 10px;
padding: 0px;
}
.pandoc-table td {
text-align: left !important;
font-size: 9px;
padding: 0px;
}
.pandoc-table caption {
    text-align: left !important;
    font-size: 11px !important;
}
.controlly{
    overflow-y:scroll;
    height:351px;
    overflow-x: scroll; 
}
</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->
<script>
function myFunction1() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
<script>
function myFunction2() {
    var x = document.getElementById("myDIV2");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
```
<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">

```{r setup, include=FALSE}
Sys.setlocale("LC_COLLATE", "Spanish_Chile.1252")
Sys.setlocale("LC_COLLATE", "Spanish_Chile.1252")
Sys.setlocale("LC_CTYPE", "Spanish_Chile.1252")
Sys.setlocale("LC_MONETARY", "Spanish_Chile.1252")
Sys.setlocale("LC_TIME", "Spanish_Chile.1252")
# ---
# title: "Gastos Casa"
# date: "`r format(Sys.time(), '%d %B, %Y')`"
# output:
#   fidelius::html_password_protected:
#     style:
#       button_text: "Ingresar clave"
#     password: "mapashito"
#     preview: false
#     hint: "la miaupeshito, miaupeshito..."
#     bundle: true
#     output_format: 
#       rmarkdown::html_document:
#         code_folding: hide  
#         toc: true # table of content true
#         toc_depth: 4  # upto three depths of headings (specified by #, ## and ###)
#         toc_float: true
#         theme: cosmo
# ---

rm(list=ls());gc()
unlink('SUD_CL/Duplicates_cache', recursive = TRUE)
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = TRUE)
if(!require(readr)){install.packages("readr")}
if(!require(rowr)){install.packages("rowr")}
if(!require(plyr)){install.packages("plyr")}
if(!require(fUnitRoots)){install.packages("fUnitRoots")}
if(!require(reshape2)){install.packages("reshape2")}
if(!require(data.table)){install.packages("data.table")}
if(!require(DataExplorer)){install.packages("DataExplorer")}
if(!require(stringi)){install.packages("stringi")}
if(!require(stringr)){install.packages("stringr")}
if(!require(zoo)){install.packages("zoo")}
if(!require(readxl)){install.packages("readxl")}
if(!require(httr)){install.packages("httr")}

if(!require(sparklyr)){install.packages("sparklyr")}
if(!require(plotrix)){install.packages("plotrix")}
if(!require(gridExtra)){install.packages("gridExtra")}
if(!require(grid)){install.packages("grid")}
if(!require(GGally)){install.packages("GGally")}
if(!require(lattice)){install.packages("lattice")}

if(!require(sjPlot)){install.packages("sjPlot")}
if(!require(gsynth)){install.packages("gsynth")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(tsibble)){install.packages("tsibble")}


if(!require(tm)){install.packages("tm")}
if(!require(SnowballC)){install.packages("SnowballC")}
if(!require(wordcloud)){install.packages("wordcloud")}
if(!require(RColorBrewer)){install.packages("RColorBrewer")}

if(!require(forecast)){install.packages("forecast")}
if(!require(xts)){install.packages("xts")}
if(!require(plotly)){install.packages("plotly")}
if(!require(rvest)){install.packages("rvest")}
if(!require(autoplotly)){install.packages("autoplotly")}
if(!require(janitor)){install.packages("janitor")}

if(!require(DT)){install.packages("DT")}
if(!require(tidytext)){install.packages("tidytext")}

if(!require(autoplotly)){devtools::install_github("terrytangyuan/autoplotly")}

require(ggplot2)
require(dplyr)
require(data.table)
require(zoo)
require(sjPlot)
require(maditr)

theme_custom <- function() {
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid.major = element_line(color = "grey80"),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  )
}
```

</div>

# 1. Gastos (cálculos antiguos)


```{r generar-base, include=F,warning=F, message=F}
if(nchar(Sys.getenv("SUPERSECRET"))<2){
  Sys.setenv("SUPERSECRET"=as.character(read.table(paste0(dirname(getwd()),"/secret_key.txt"), quote="\"", comment.char="")))
}
if(nchar(Sys.getenv("SUPERSECRET"))<2){
  try(Sys.setenv("SUPERSECRET"=as.character(read.table(paste0(gsub("/gastos","",dirname(rstudioapi::getActiveDocumentContext()$path)),"/secret_key.txt"), quote="\"", comment.char=""))))
}

path_sec<- paste0("https://docs.google.com/spreadsheets/d/",Sys.getenv("SUPERSECRET"),"/export?format=csv&id=",Sys.getenv("SUPERSECRET"),"&gid=1386184641")

Gastos_casa <- readr::read_csv(as.character(path_sec),
                col_names = c("Tiempo", "gasto", "fecha", "obs", "monto", "gastador",
                              "link"),skip=1)
```

::: controlly
```{r vista-preliminar, warning=F, message=F}
Gastos_casa %>% 
  dplyr::select(-Tiempo,-link) %>%
  dplyr::select(fecha, gasto, monto, gastador,obs) %>% tail(30) %>% 
  knitr::kable(format = "markdown", size=12)
```
:::


```{r head-gastos-casa, echo=FALSE, eval=F,echo=F}
head(Gastos_casa)
```


```{r fig-1, echo=FALSE, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Tipos de Gasto por Persona"}

Gastos_casa %>% 
  dplyr::mutate(gastos_mod=dplyr::case_when(gasto=="Gas"~"Gas/Bencina",
    gasto=="aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                            gasto=="Tina"~"electrodomésticos/mantención casa",
                                            gasto=="Nexium"~"Farmacia",
                                            gasto=="donaciones"~"donaciones/regalos",
                                            gasto=="Regalo chocolates"~"donaciones/regalos",
                                            gasto=="filtro piscina msp"~"electrodomésticos/mantención casa",
                                            gasto=="Chromecast"~"electrodomésticos/mantención casa",
                                            gasto=="Muebles ratan"~"electrodomésticos/mantención casa",
                                            gasto=="Vacuna Influenza"~"Farmacia",
                                            gasto=="Easy"~"electrodomésticos/mantención casa",
                                            gasto=="Sopapo"~"electrodomésticos/mantención casa",
                                            gasto=="filtro agua"~"electrodomésticos/mantención casa",
                                            gasto=="ropa tami"~"donaciones/regalos",
                                            gasto=="yaz"~"Farmacia",
                                            gasto=="Yaz"~"Farmacia",
                                            gasto=="Remedio"~"Farmacia",
                                            gasto=="Entel"~"VTR",
                                            gasto=="Kerosen"~"Gas/Bencina",
                                            gasto=="Parafina"~"Gas/Bencina",
                                            gasto=="Plata basurero"~"donaciones/regalos",
                                            gasto=="Matri Andrés Kogan"~"donaciones/regalos",
                                            gasto=="Wild Protein"~"Comida",
                                            gasto=="Granola Wild Foods"~"Comida",
                                            gasto=="uber"~"Transporte",
                                            gasto=="Uber Reñaca"~"Transporte",
                                            gasto=="filtro piscina mspa"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza Alfombra"~"electrodomésticos/mantención casa",
                                            gasto=="Aspiradora"~"electrodomésticos/mantención casa",
                                            gasto=="Limpieza alfombras"~"electrodomésticos/mantención casa",
                                            gasto=="Pila estufa"~"electrodomésticos/mantención casa",
                                            gasto=="Reloj"~"electrodomésticos/mantención casa",
                                            gasto=="Arreglo"~"electrodomésticos/mantención casa",
                                            gasto=="Pan Pepperino"~"Comida",
                                            gasto=="Cookidoo"~"Comida",
                                            gasto=="remedios"~"Farmacia",
                                            gasto=="Bendina Reñaca"~"Gas/Bencina",
                                            gasto=="Bencina Reñaca"~"Gas/Bencina",
                                            gasto=="Vacunas Influenza"~"Farmacia",
                                            gasto=="Plata fiestas patrias basureros"~"donaciones/regalos",
                                              T~gasto)) %>% 
ggplot2::ggplot(aes(x=as.factor(gastos_mod),y=as.numeric(monto))) + 
  geom_bar(stat="identity") + 
  theme_minimal() +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000," Mil")) + 
  theme(axis.text.x = element_text(angle = 45, vjust=0.5, size= 11)) +
  facet_wrap(~gastador) +
  labs(
    x = "Ítems",
    y = "Gasto (por miles)",
    title = paste(
      "Figura 1. Tipos de Gasto por Persona (TOTAL)"
    )
  ) 
```

```{r gasto-tot-por-gastador, echo=FALSE, fig.height=4, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura. Promedio de gasto por gastador", cache=T}

#para ver las diferencias depués de la diosi
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
    dplyr::group_by(gastador, fecha,.drop = F) %>% 
    dplyr::summarise(gasto_media=mean(monto,na.rm=T)) %>% 
    dplyr::mutate(treat=ifelse(fecha>"2019-W26",1,0)) %>%
    #dplyr::mutate(fecha_simp=lubridate::week(fecha)) %>%#después de  diosi. Junio 24, 2019	
    dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés"))) %>% 
    assign("ts_gastos_casa_week_treat", ., envir = .GlobalEnv) 

gplots::plotmeans(gasto_media ~ gastador_nombre, main="Promedio de gasto por gastador", data=ts_gastos_casa_week_treat,ylim=c(0,75000), xlab="", ylab="")

```

```{r comp_medias-por-diosi, echo=T, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Antes y Depsués de Diosi"}
library(ggplot2)

ggplot(
  ts_gastos_casa_week_treat,
  aes(x = gastador_nombre, y = gasto_media)
) +
  stat_summary(fun = mean, geom = "point", size = 3, color = "steelblue") +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.2) +
  facet_wrap(~ treat, labeller = labeller(
    treat = c(`0` = "Antes de Diosi", `1` = "Después de Diosi")
  )) +
  coord_cartesian(ylim = c(0, 70000)) +
  labs(x = "", y = "") +
  theme_minimal(base_size = 13) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r linea-tiempo-gastador-gastos, echo=T, fig.height=4, fig.width=8, warning=FALSE, fig.align = "center", message=F ,fig.show='hide'}
library(ggiraph)
library(scales)
#if( requireNamespace("dplyr", quietly = TRUE)){
gg <- Gastos_casa %>%
  dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
  dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
  dplyr::mutate(fecha_simp=tsibble::yearweek(fecha)) %>%
  dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
  dplyr::mutate(treat=ifelse(fecha_week>"2019 W26",1,0)) %>%
  dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés"))) %>% 
#  dplyr::mutate(week=as.Date(as.character(lubridate::floor_date(fecha, "week"))))%>%
  #dplyr::mutate(fecha_week= lubridate::parse_date_time(fecha_week, c("%Y-W%V"),exact=T)) %>% 
  dplyr::group_by(gastador_nombre, fecha_simp) %>%
  dplyr::summarise(monto_total=sum(monto)) %>%
  dplyr::mutate(tooltip= paste0(substr(gastador_nombre,1,1),"=",round(monto_total/1000,2))) %>%
  ggplot(aes(hover_css = "fill:none;")) +#, ) +
  #stat_summary(geom = "line", fun.y = median, size = 1, alpha=0.5, aes(color="blue")) +
  geom_line(aes(x = fecha_simp, y = monto_total, color=as.factor(gastador_nombre)),size=1,alpha=.5) +
                       ggiraph::geom_point_interactive(aes(x = fecha_simp, y = monto_total, color=as.factor(gastador_nombre),tooltip=tooltip),size = 1) +
  #geom_text(aes(x = fech_ing_qrt, y = perc_dup-0.05, label = paste0(n)), vjust = -1,hjust = 0, angle=45, size=3) +
 # guides(color = F)+
  theme_custom() +
  geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
  labs(y="Gastos (en miles)",x="Semanas y Meses", subtitle="Interlineado, incorporación de la Diosi; Azul= Tami; Rojo= Andrés") + ggtitle( "Figura 4. Gastos por Gastador") +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000)) + 
  scale_color_manual(name = "Gastador", values= c("blue", "red"), labels = c("Tami", "Andrés")) +
  tsibble::scale_x_yearweek(date_breaks = "1 month", minor_breaks = "1 week", labels=scales::date_format("%m/%y")) +
  theme(axis.text.x = element_text(vjust = 0.5,angle = 35), legend.position='bottom')+
     theme(
    panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_line(colour = "black")
    )

#  x <- girafe(ggobj = gg)
#  x <- girafe_options(x = x,
#                      opts_hover(css = "stroke:red;fill:orange") )
#  if( interactive() ) print(x)

#}
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"

#ggiraph(code = {print(gg)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75 )

x <- girafe(ggobj = gg)
x <- girafe_options(x,
  opts_zoom(min = 1, max = 3), opts_hover(css =tooltip_css))
```

``` {r print-linea-tiempo-gastador-gastos , echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE,caption="Figura. Línea de Tiempo por Gastador y Gastos"}
x
```

```{r month-gastos,echo=T,fig.align='center', echo=T, fig.pos='H', eval=T, message=FALSE, warning=F}
plot<-Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(month=as.Date(as.character(lubridate::floor_date(fecha, "month"))))%>%
    dplyr::group_by(month)%>%
    dplyr::summarise(gasto_total=sum(monto)/1000) %>%
      ggplot2::ggplot(aes(x = month, y = gasto_total)) +
      geom_point()+
      geom_line(size=1) +
      theme_custom() +
      geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
      geom_vline(xintercept = as.Date("2019-03-23"),linetype = "dashed", color="red") +
      labs(y="Gastos (en miles)",x="Meses/Año", subtitle="Interlineado, incorporación de la Diosi") + 
      ggtitle( "Figura. Suma de Gastos por Mes") +        
      scale_x_date(breaks = "1 month", minor_breaks = "1 month", labels=scales::date_format("%m/%y")) +
      theme(axis.text.x = element_text(vjust = 0.5,angle = 45)) 
plotly::ggplotly(plot)  
```



```{r ts-month-gastos,echo=T,fig.align='center', echo=T, fig.pos='H', eval=T, message=FALSE, warning=F}
plot2<-Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(day)%>%
    summarise(gasto_total=sum(monto)/1000) %>%
      ggplot2::ggplot(aes(x = day, y = gasto_total)) +
      geom_line(size=1) +
      theme_custom() +
      geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
      geom_vline(xintercept = as.Date("2020-03-23"),linetype = "dashed", color="red") +
      labs(y="Gastos (en miles)",x="Meses/Año", subtitle="Interlineado, incorporación de la Diosi") + 
      ggtitle( "Figura. Suma de Gastos por Día") +        
      scale_x_date(breaks = "1 month", minor_breaks = "1 week", labels=scales::date_format("%m/%y")) +
      theme(axis.text.x = element_text(vjust = 0.5,angle = 45)) 
plotly::ggplotly(plot2)  

tsData <- Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(day)%>%
    summarise(gasto_total=sum(monto))%>%
    dplyr::mutate(covid=case_when(day>as.Date("2019-06-02")~1,TRUE~0))%>%
    dplyr::mutate(covid=case_when(day>as.Date("2020-03-10")~covid+1,TRUE~covid))%>%
    dplyr::mutate(covid=as.factor(covid))%>%
  data.frame()
```


```{r descompone_la_serie,echo=T, echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE,caption="Figura. Serie descompuesta"}

tsData_gastos <-ts(tsData$gasto_total, frequency=7)
mstsData_gastos <- forecast::msts(Gastos_casa$monto, seasonal.periods=c(7,30))

tsData_gastos = decompose(tsData_gastos)

tsdata_gastos_trend<-cbind(tsData,trend=as.vector(tsData_gastos$trend))%>% na.omit()

# Assuming your time series starts on "2019-03-03"
start_date <- as.Date("2019-03-03")
frequency <- 7  # Weekly data
num_periods <- length(tsData_gastos$x)  # Total number of periods in your time series

# Generate sequence of dates
dates <- tsData$day# seq.Date(from = start_date, by = "day", length.out = num_periods)

# Create a data frame from the decomposed time series object
tsData_gastos_df <- data.frame(
  day = dates,
  Actual = as.numeric(tsData_gastos$x),
  Seasonal = as.numeric(tsData_gastos$seasonal),
  Trend = as.numeric(tsData_gastos$trend),
  Random = as.numeric(tsData_gastos$random)
)

tsData_gastos_long <- tsData_gastos_df %>%
  pivot_longer(cols = c("Actual", "Seasonal", "Trend", "Random"), 
               names_to = "Component", values_to = "Value")

# Plotting with facet_wrap
ggplot(tsData_gastos_long, aes(x = day, y = Value)) +
  geom_line() +
  theme_bw() + 
  labs(title = "Descomposición de los Gastos Diarios", x = "Date", y = "Value") +
  scale_x_date(date_breaks = "3 months", date_labels = "%m %Y") +
  facet_wrap(~ Component, scales = "free_y", ncol=1) +
theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme(strip.text = element_text(size = 12))
```

Ahora con las tendencias descompuestas
 
```{r linea-tiempo-gastador-gastos-tipo, eval=T, echo=T, fig.height=16, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Gasto Mensual"}
#require(zoo)
Gastos_casa_gastador_cat_gasto<- 
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha2=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(gastador=ifelse(gastador=="Andrés",1,0)) %>%
    dplyr::mutate(treat=ifelse(fecha2>"2019-W26",1,0)) %>% 
    dplyr::mutate(
      # 1) Normalización básica de texto
      gasto_clean = gasto %>%
        stringr::str_squish() %>%                   # espacios extra
        stringr::str_to_lower() %>%                 # todo en minúsculas
        stringr::str_replace_all(",", "") %>%       # quita comas, si hubiera
        stringr::str_replace_all("\\s+/\\s+", "/") %>%  # "a / b" -> "a/b"
        stringi::stri_trans_general("Latin-ASCII"),  # sin tildes
      
      # 2) Unificar etiquetas que son lo mismo
      gasto_clean = dplyr::case_when(
        gasto_clean %in% c("uber", "uber reñaca", "uber matri cony", "uber cumple papa") ~ "uber",
        gasto_clean %in% c("yaz", "yaz ") ~ "yaz",
        gasto_clean %in% c("limpieza alfombras", "limpieza alfombra") ~ "limpieza alfombras",
        gasto_clean %in% c("vacuna influenza", "vacunas influenza") ~ "vacuna influenza",
        gasto_clean %in% c("aspiradora", "aspiradora ") ~ "aspiradora",
        gasto_clean %in% c("plata reciclaje y basurero",
                           "plata basurero", "plata basureros",
                           "plata fiestas patrias basureros",
                           "aporte basureros", "basureros") ~ "basureros",
        gasto_clean %in% c("donaciones", "donacion") ~ "donacion",
        gasto_clean %in% c("prestamo", "prestamo andres", "prestamo andres", "prestamo andres ") ~ "prestamo andres",
        TRUE ~ gasto_clean
      ),
      # 3) (Opcional) Variable más agregada de tipo de gasto
      gasto_cat = dplyr::case_when(
        gasto_clean == "comida"                       ~ "Comida",
        gasto_clean %in% c("enceres")                 ~ "Enceres",
        gasto_clean == "diosi"                        ~ "Diosi",
        gasto_clean %in% c("vtr", "netflix",
                           "crunchyroll", "entel")    ~ "Streaming/Telefonia",
        gasto_clean %in% c("electricidad", "gas",
                           "parafina", "kerosen")     ~ "Servicios básicos",
        gasto_clean %in% c("agua")                    ~ "Agua",
        gasto_clean %in% c("uber", "transporte",
                           "gas/bencina", "bencina + tag",
                           "bencina reñaca",
                           "bencina + peajes maite",
                           "bencina + tag cumple delox") ~ "Transporte",
        gasto_clean %in% c("farmacia", "remedio",
                           "remedios", "remedios covid",
                           "gaviscón y paracetamol",
                           "nexium")                 ~ "Farmacia/Salud",
        gasto_clean %in% c("electrodomesticos/mantencion casa",
                           "microondas regalo", "aspiradora",
                           "muebles ratan", "mouse",
                           "reloj")                  ~ "Electrodomesticos",
        TRUE ~ stringr::str_to_title(gasto_clean)  # default: limpio pero no agregado
      )
    ) %>%
    dplyr::mutate(
      gasto_cat10 = dplyr::case_when(
        # 1) COMIDA (incluye los “comida” especiales de tu criterio viejo)
        gasto_cat %in% c(
          "Comida",
          "Pan Pepperino",
          "Cookidoo",
          "Granola Wild Foods",
          "Wild Protein",
          "Brussels"
        ) ~ "Comida",
        # 2) ENCERES
        gasto_cat %in% c(
          "Enceres",
          "Incoludido",
          "Tres Toques"
        ) ~ "Enceres",
        # 3) DIOSI
        gasto_cat == "Diosi" ~ "Diosi",
        # 4) SERVICIOS BÁSICOS (agua, luz, gas/bencina, etc.)
        gasto_cat %in% c(
          "Servicios básicos",
          "Agua",
          "Bencina Renaca"
        ) ~ "Servicios básicos",
        # 5) FARMACIA (todo lo que en tu criterio iba a Farmacia)
        gasto_cat %in% c(
          "Farmacia/Salud",
          "Yaz",
          "Gaviscon Y Paracetamol",
          "Vacuna Influenza",
          "Cruz Verde"
        ) ~ "Farmacia",
        # 6) TRANSPORTE (uber, viajes, bencina que antes era Transporte)
        gasto_cat %in% c(
          "Transporte",
          "Uber Renaca",
          "Viaje Brasil"
        ) ~ "Transporte",
        # 7) ELECTRODOMÉSTICOS / MANTENCIÓN CASA
        gasto_cat %in% c(
          "Electrodomesticos",
          "Cortina Bano",
          "Filtro Agua",
          "Filtro Piscina Mspa",
          "Mantencion Toyotomi",
          "Limpieza Alfombras",
          "Sopapo",
          "Pila Estufa",
          "Jardinero",
          "Camaras Seguridad M.barrios",
          "Pago Camaras Mb",
          "Tina",
          "Nacho",
          "Lamina",
          "Chromecast",
          "Easy"
        ) ~ "Electrodomesticos/mantencion casa",
        # 8) STREAMING / TELEFONÍA (Netflix / VTR / Crunchyroll / Entel, que ya aglutinaste en gasto_cat)
        gasto_cat %in% c(
          "Streaming/Telefonia"
        ) ~ "Streaming/Telefonia",
        # 9) DONACIONES / REGALOS / APORTES
        gasto_cat %in% c(
          "Basureros",
          "Donacion",
          "Regalo Chocolates",
          "Regalo Matri Chepa",
          "Regalo Matri Cony",
          "Matri Andres Kogan",
          "Rgalo Chepa",
          "Ropa",
          "Ropa Tami",
          "Assistcard Viaje"
        ) ~ "Donaciones/regalos",
        # 10) TODO LO DEMÁS → OTROS
        TRUE ~ "Otros"
      )
    ) %>%
    dplyr::group_by(gastador, fecha, gasto_cat10, .drop=F) %>%
    dplyr::summarise(monto=sum(monto)) %>% 
    dplyr::mutate(gastador_nombre=plyr::revalue(as.character(gastador), c("0" = "Tami", "1"="Andrés")))




Gastos_casa_gastador_cat_gasto %>%
    dplyr::mutate(fecha = as.Date(fecha)) %>%       # por si viene como POSIXct
    dplyr::group_by(gasto_cat10) %>%                     # opcional: quita ítems con 1 obs
    dplyr::filter(n() >= 6) %>%   
    dplyr::ungroup() %>%
ggplot2::ggplot(aes(x = fecha, y = monto, color=as.factor(gastador_nombre))) +
  #stat_summary(geom = "line", fun.y = median, size = 1, alpha=0.5, aes(color="blue")) +
  geom_line(size=1) +
  facet_grid(gasto_cat10~.)+
  geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
  labs(y="Gastos (en miles)",x="Años", subtitle="Interlineado, incorporación de la Diosi; Azul= Tami; Rojo= Andrés") +
  ggtitle( "Figura 6. Gastos Semanales por Gastador e ítem (media) [n>5]") +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000)) + 
  scale_color_manual(name = "Gastador", values= c("blue", "red"), labels = c("Tami", "Andrés")) +
  tsibble::scale_x_yearweek(breaks = "1 year", minor_breaks = "3 months", labels= scales::date_format("%m/%y")) +
  guides(color = F)+
  theme_custom() +
  theme(axis.text.x = element_text(vjust = 0.5,angle = 35)) +
  theme(
    panel.border = element_blank(), 
    #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(), 
    panel.grid.minor = element_line(color = "grey90", size = 0.3),
    panel.grid.major = element_line(color = "grey75", size = 0.5),    
    axis.line = element_line(colour = "black")
    )
```

```{r mstl, eval=T, fig.height=8, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura. Gasto descompuesto en Tendencias"}
# Apply MSTL decomposition

Gastos_casa |> 
    dplyr::mutate(fecha= readr::parse_date(fecha, format="%d/%m/%Y")) |> 
    dplyr::arrange(fecha) |>  pull(monto) -> monto_ts
Gastos_casa |> 
    dplyr::mutate(fecha= readr::parse_date(fecha, format="%d/%m/%Y")) |> 
    dplyr::arrange(fecha) |>  pull(fecha) -> fecha_ts

mstl_data_autplt <- forecast::mstl(monto_ts, lambda = "auto",iterate=5000000,start = 
lubridate::decimal_date(as.Date("2019-03-03")))

# Convert the decomposed time series to a data frame
mstl_df <- data.frame(
  Date = as.Date(fecha_ts, format="%d/%m/%Y"),
  Data = as.numeric(mstl_data_autplt[, "Data"]),
  Trend = as.numeric(mstl_data_autplt[, "Trend"]),
  Remainder = as.numeric(mstl_data_autplt[, "Remainder"])
)

# Reshape the data frame for ggplot2
mstl_long <- mstl_df %>%
  dplyr::arrange(Date) %>%
  tidyr::pivot_longer(cols = -Date, names_to = "Component", values_to = "Value")

mstl_long_filtered <- mstl_long %>% dplyr::filter(!(Date %in% (mstl_long %>% dplyr::distinct(Date) %>% top_n(7, Date) %>% pull(Date))))

# Plotting with ggplot2
ggplot(mstl_long_filtered, aes(x = Date, y = Value)) +
  geom_line() +
  theme_bw() + 
  labs(title = "Descomposición MSTL (- 7 days)", x = "Fecha", y = "Valor") +
  scale_x_date(date_breaks = "3 months", date_labels = "%m-%Y") +
  facet_wrap(~ Component, scales = "free_y", ncol = 1) +
  theme(strip.text = element_text(size = 12),
        axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r bsts, eval=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Proyección de Gasto Semanal Pre-Post COVID, Interrupción de Tiempo"}

ts_week_covid<-  
Gastos_casa %>%
    dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
    dplyr::mutate(fecha_week=strftime(fecha, format = "%Y-W%V")) %>%
    dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))%>%
    dplyr::group_by(fecha_week)%>%
    dplyr::summarise(gasto_total=sum(monto,na.rm=T)/1000,min_day=min(day))%>%
    dplyr::ungroup() %>% 
    dplyr::mutate(covid=dplyr::case_when(min_day>=as.Date("2020-03-17")~1,TRUE~0))%>%
    dplyr::mutate(covid=as.factor(covid))%>%
    data.frame()


ts_week_covid$gasto_total_na<-ts_week_covid$gasto_total
post_resp<-ts_week_covid$gasto_total[which(ts_week_covid$covid==1)]
ts_week_covid$gasto_total_na[which(ts_week_covid$covid==1)]<-NA
ts_week_covid$gasto_total[which(ts_week_covid$covid==0)]
```

```{r nube-de-palabras-gastos, eval=T, fig.height=4, fig.width=8, echo=T, warning=FALSE, fig.align = "center", message=F, caption="Figura 10. Nube de Palabras, Observaciones"}
# 1) Create corpus
corpus <- tm::Corpus(tm::VectorSource(Gastos_casa$obs))

# 2) Preprocess text
d <- corpus |>
  tm::tm_map(tm::content_transformer(tolower)) |>
  tm::tm_map(tm::stripWhitespace) |>
  tm::tm_map(tm::removePunctuation) |>
  tm::tm_map(tm::removeNumbers) |>
  tm::tm_map(tm::removeWords, tm::stopwords("spanish")) |>
  tm::tm_map(tm::removeWords, "menos")

# 3) Term-document matrix
tdm <- tm::TermDocumentMatrix(d)

# 4) Convert to matrix
m <- base::as.matrix(tdm)

# 5) Frequencies
v  <- base::sort(base::rowSums(m), decreasing = TRUE)

df <- base::data.frame(
  word = base::names(v),
  freq = v,
  row.names = NULL
)

# 6) Wordcloud
wordcloud::wordcloud(
  words       = df$word,
  freq        = df$freq,
  max.words   = 100,
  random.order= FALSE,
  rot.per     = 0.35,
  colors      = RColorBrewer::brewer.pal(8, "Dark2"),
  scale       = c(4, 0.5)
)

```

::: controlly
```{r month-gasto-recategorizar, echo=T,fig.align='center', fig.pos='H', eval=T, message=FALSE, warning=F}

fit_month_gasto <- Gastos_casa_gastador_cat_gasto %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    # month string YYYY-MM
    fecha_month = base::format(fecha, "%Y-%m")
  ) %>%
  dplyr::mutate(
    # order months from 2019-03 until today (like in your original code)
    fecha_month = base::factor(
      fecha_month,
      levels = base::format(
        base::seq(
          from = base::as.Date("2019-03-03"),
          to   = base::as.Date(base::substr(base::Sys.time(), 1, 10)),
          by   = "1 month"
        ),
        "%Y-%m"
      )
    )
  ) %>%
  dplyr::group_by(fecha_month, gasto_cat10, .drop = FALSE) %>%
  dplyr::summarise(
    gasto_total = base::sum(monto, na.rm = TRUE) / 1000,
    .groups = "drop"
  ) %>%
  base::as.data.frame()

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
current_ym <- base::format(base::Sys.Date(), "%Y-%m")

tabla_gasto_year_item <-
    fit_month_gasto %>%
    dplyr::mutate(
        year = base::substr(base::as.character(fecha_month), 1, 4),
        ym   = base::as.character(fecha_month)
    ) %>%
    # opcional: excluir el mes actual (incompleto)
    dplyr::filter(ym != current_ym) %>%
    # si quieres solo ciertos años:
    # dplyr::filter(year %in% c("2020","2021","2022","2023","2024","2025")) %>%
    dplyr::group_by(gasto_cat10, year) %>%
    dplyr::summarise(
        gasto_prom = base::mean(gasto_total, na.rm = TRUE),
        .groups    = "drop"
    ) %>%
    tidyr::pivot_wider(
        names_from  = year,
        values_from = gasto_prom
    ) %>%
    janitor::adorn_totals()  # agrega fila "Total"

tabla_gasto_year_item |> 
  knitr::kable("markdown",
    caption = "Gasto Promedio Mensual por Ítem y Año (suma por categoría y mes)",
    digits  = 1)
```
:::
 

```{r month-gasto-recategorizar2, echo=FALSE}
# (Opcional) Cargar paquetes si quieres autocomplete, pero el código abajo usa todo namespaced
# library(dplyr)
# library(tidytext)
# library(ggplot2)
# library(stringi)
# library(tm)
# library(tidytext)

# 1) Base de texto
chat <- base::data.frame(Gastos_casa$obs) |>
  dplyr::rename(Gastos_casa.obs = Gastos_casa.obs) |>
  dplyr::mutate(
    count_character = base::nchar(Gastos_casa.obs),
    words = base::nchar(base::gsub("[^ ]+", "", Gastos_casa.obs)) + 1
  )

# 2) Stopwords personalizadas
to_remove <- base::c(
  tm::stopwords(kind = "spanish"),
  "usted", "ahí", "aquí", "acá", "pues", "tal", "tan", "así", "dijo", "dicen",
  "xq", "status", "wnes", "jaja", "jajaj", "tb", "t", "mensaje",
  "cómo", "sino", "entonces", "aunque", "don", "doña", "nomas", "si", "pa",
  "jajajaja", "jjaja", "alla", "creo", "cada", "le", "el", "la", "en",
  "weon", "wea", "q", "jajaja", "ajaja", "igual", "pasa", "pasan", "hace",
  "manda", "cacha", "multimedia", "wn", "po", "cn", "pal", "ta",
  "ajajajja", "ajajajjaja", "seee", "ajajajajja", "wajajajajajjaja",
  "wajajaja", "10", "1", "pq", "jajajajajajaja", "k",
  "toda", "ahora", "tema", "omitido", "que", "Porqué", "siempre", "https",
  "toy", "mas", "2", "3", "hacen", "hacer", "ajajajajaja", "jajajajajaja",
  "jajajajaja", "jajajajaja"
)

# 3) Reemplazar stopwords por espacio en el texto original
chat$text2 <- stringi::stri_replace_all_regex(
  chat$Gastos_casa.obs,
  pattern    = base::paste0(" ", to_remove, " "),
  replacement= base::rep(" ", base::length(to_remove)),
  vectorize  = FALSE
)

# 4) Versión "limpia" tokenizada (si la quieres conservar)
chat_clean <- chat |>
  tidytext::unnest_tokens(output = word, input = text2) |>
  dplyr::anti_join(tidytext::stop_words, by = "word") |>
  dplyr::filter(!base::is.na(word)) |>
  dplyr::filter(!word %in% to_remove)

# 5) Conteo top 20 palabras (gráfico)
chat |>
  tidytext::unnest_tokens(output = word, input = text2) |>
  dplyr::filter(!word %in% to_remove) |>
  dplyr::count(word, sort = TRUE) |>
  dplyr::slice_max(order_by = n, n = 20, with_ties = FALSE) |>
  dplyr::filter(!base::is.na(word)) |>
  ggplot2::ggplot(ggplot2::aes(x = stats::reorder(word, n), y = n)) +
  ggplot2::geom_col(show.legend = FALSE) +
  ggplot2::ylab("") +
  ggplot2::xlab("") +
  ggplot2::coord_flip() +
  tidytext::scale_x_reordered() +
  ggplot2::ggtitle("Figura. Gastos detallados más usados")

```

<br>

# 2. UF Proyectada

Saqué la UF proyectada 

```{r ufs, echo=T, paged.print=TRUE,eval=T}
#options(max.print=5000)

uf18 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2018.htm")%>% rvest::html_nodes("table")
uf19 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2019.htm")%>% rvest::html_nodes("table")
uf20 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2020.htm")%>% rvest::html_nodes("table")
uf21 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2021.htm")%>% rvest::html_nodes("table")
uf22 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2022.htm")%>% rvest::html_nodes("table")
uf23 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2023.htm")%>% rvest::html_nodes("table")
uf24 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2024.htm")%>% rvest::html_nodes("table")

tryCatch(uf25 <-rvest::read_html("https://www.sii.cl/valores_y_fechas/uf/uf2025.htm")%>% rvest::html_nodes("table"),
    error = function(c) {
      uf24b <<- cbind.data.frame(Día=NA, variable=NA, value=NA)
      
    }
  )

tryCatch(uf25 <-uf25[[length(uf25)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1),
    error = function(c) {
      uf25 <<- cbind.data.frame(Día=NA, variable=NA, value=NA)
    }
)

uf_serie<-
bind_rows(
cbind.data.frame(anio= 2018, uf18[[length(uf18)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),
cbind.data.frame(anio= 2019, uf19[[length(uf19)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),
cbind.data.frame(anio= 2020, uf20[[length(uf20)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),
cbind.data.frame(anio= 2021, uf21[[length(uf21)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),
cbind.data.frame(anio= 2022, uf22[[length(uf22)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),
cbind.data.frame(anio= 2023, uf23[[length(uf23)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),
cbind.data.frame(anio= 2024, uf23[[length(uf24)]] %>% rvest::html_table() %>% data.frame() %>% reshape2::melt(id.vars=1)),
cbind.data.frame(anio= 2025, uf25)
)

uf_serie_corrected<-
uf_serie %>% 
dplyr::mutate(month=plyr::revalue(tolower(.[[3]]),c("ene" = 1, "feb"=2, "mar"=3, "abr"=4, "may"=5, "jun"=6, "jul"=7, "ago"=8, "sep"=9, "oct"=10, "nov"=11, "dic"=12))) %>% 
  dplyr::mutate(value=stringr::str_trim(value), value= sub("\\.","",value),value= as.numeric(sub("\\,",".",value))) %>% 
  dplyr::mutate(date=paste0(sprintf("%02d", .[[2]])," ",sprintf("%02d",as.numeric(month)),", ",.[[1]]), date3=lubridate::parse_date_time(date,c("%d %m, %Y"),exact=T),date2=date3) %>% 
   na.omit()#%>%  dplyr::filter(is.na(date3))
#Day of the month as decimal number (1–31), with a leading space for a single-digit number.
#Abbreviated month name in the current locale on this platform. (Also matches full name on input: in some locales there are no abbreviations of names.)

warning(paste0("number of observations:",nrow(uf_serie_corrected),",  min uf: ",min(uf_serie_corrected$value),",  min date: ",min(uf_serie_corrected $date3 )))
# 
# uf_proyectado <- readxl::read_excel("uf_proyectado.xlsx") %>% dplyr::arrange(Período) %>% 
#   dplyr::mutate(Período= as.Date(lubridate::parse_date_time(Período, c("%Y-%m-%d"),exact=T)))
ts_uf_proy<-
ts(data = uf_serie_corrected$value, 
   start = as.numeric(as.Date("2018-01-01")), 
   end = as.numeric(as.Date(uf_serie_corrected$date3[length(uf_serie_corrected$date3)])), frequency = 1,
   deltat = 1, ts.eps = getOption("ts.eps"))

fit_tbats <- forecast::tbats(ts_uf_proy)

fr_fit_tbats<-forecast::forecast(fit_tbats, h=298)
```

```{r 1-NIXTLA, echo=T, paged.print=TRUE,eval=T, error=T, fig.align='center', fig.pos='H', caption="Figura. Proyección de UF , Modelo TimeGPT"}
# Configurar API Key
if(nchar(Sys.getenv("API_NIXTLA"))<2){
  Sys.setenv("API_NIXTLA"=as.character(read.table(paste0(dirname(getwd()),"/nixtlar_api_key.txt"), quote="\"", comment.char="")))
}
if(nchar(Sys.getenv("API_NIXTLA"))<2){
  try(Sys.setenv("API_NIXTLA"=as.character(read.table(paste0(gsub("/gastos","",dirname(rstudioapi::getActiveDocumentContext()$path)),"/nixtlar_api_key.txt"), quote="\"", comment.char=""))))
}

try(nixtlar::nixtla_set_api_key(Sys.getenv("NIXTLA")))
if(nchar(Sys.getenv("NIXTLA"))<2){
  nixtlar::nixtla_set_api_key(Sys.getenv("API_NIXTLA"))
}

# Preparar datos en formato requerido por TimeGPT
uf_timegpt <- uf_serie_corrected %>%
    dplyr::rename(ds = date3, y = value) %>%
    dplyr::mutate(ds = format(ds, "%Y-%m-%d")) %>%
    dplyr::mutate(unique_id = "serie_1")%>%
    dplyr::select(unique_id, ds, y)

# Realizar pronóstico con TimeGPT
timegpt_fcst <- nixtlar::nixtla_client_forecast(
  uf_timegpt,
  h = 298,               # 298 días a pronosticar
  freq = "D",            # Frecuencia diaria
  add_history = FALSE,     # Incluir datos históricos en el output
  level = c(80,95),
  model=  "timegpt-1-long-horizon", 
  clean_ex_first = TRUE
)
# The Conflict: The API endpoint for the long-horizon model likely does not support generating "fitted values" for the historical input data, causing the server to return "Unprocessable Entity" (422).

# 1. Convertir 'ds' a fecha en ambas tablas
uf_timegpt <- uf_timegpt %>% 
    mutate(ds = as.Date(ds))

timegpt_fcst <- timegpt_fcst %>% 
    mutate(ds = as.Date(ds))

# 2. Combinar los datos históricos y el pronóstico
full_data <- bind_rows(
    uf_timegpt %>% mutate(type = "Histórico"),
    timegpt_fcst %>% mutate(type = "Pronóstico")
)


# Ensure dates are Date objects
uf_timegpt <- uf_timegpt %>% mutate(ds = as.Date(ds))
timegpt_fcst <- timegpt_fcst %>% mutate(ds = as.Date(ds))

ggplot() +
    # --- FORECAST LAYERS (Map y to 'TimeGPT') ---
    # 95% Confidence Interval
    geom_ribbon(data = timegpt_fcst, 
                aes(x = ds, ymin = `TimeGPT-lo-95`, ymax = `TimeGPT-hi-95`), 
                fill = "#4B9CD3", alpha = 0.2) +
    # 80% Confidence Interval
    geom_ribbon(data = timegpt_fcst, 
                aes(x = ds, ymin = `TimeGPT-lo-80`, ymax = `TimeGPT-hi-80`), 
                fill = "#4B9CD3", alpha = 0.3) +
    # Forecast Line
    geom_line(data = timegpt_fcst, 
              aes(x = ds, y = TimeGPT, color = "Pronóstico"), size = 1) +

    # --- HISTORICAL LAYER (Map y to 'y') ---
    geom_line(data = uf_timegpt, 
              aes(x = ds, y = y, color = "Histórico"), size = 1) +

    # --- STYLING ---
    geom_vline(xintercept = max(uf_timegpt$ds), 
               linetype = "dashed", color = "red", size = 0.8) +
    scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
    scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
    scale_color_manual(name = "Leyenda", 
                       values = c("Histórico" = "black", "Pronóstico" = "#4B9CD3")) +
    # Configuración del eje x
    scale_x_date(
        date_breaks = "3 months",  # Reduce la frecuencia de las etiquetas
        date_labels = "%b %Y",  # Formato de etiquetas (mes y año)
    ) +
    # Configuración del eje y
    scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
    # Configuración de colores
    scale_color_manual(
        name = "Leyenda",
        values = c("Histórico" = "black", "Pronóstico" = "#4B9CD3")
    ) +
    # Títulos y subtítulos
    labs(
        title = "Pronóstico de UF, Serie Temporal con TimeGPT",
        subtitle = "Intervalos de confianza al 80% (más oscuro) y 95% (más claro)",
        x = "Fecha",
        y = "Valor",
        color = "Leyenda"
    ) +
    # Tema y estilos
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
    )
```


```{r 1-prophet, echo=T, paged.print=TRUE,eval=T, error=T, fig.align='center', fig.pos='H', caption="Figura. Proyección de UF , Modelo Prohet"}
library(prophet)
  model <- prophet(
  cbind.data.frame(ds= as.Date(uf_timegpt$ds), y=uf_timegpt$y),
  # Trend flexibility
  growth = "linear",
  changepoint.prior.scale = 0.05,  # Reduced for smoother trend
  n.changepoints = 50,  # Increased from default 25
  
  # Seasonality
  yearly.seasonality = TRUE,
  weekly.seasonality = TRUE,
  daily.seasonality = FALSE,  # Disabled for daily data
  seasonality.mode = "additive",
  seasonality.prior.scale = 15,  # Increased to capture stronger seasonality
  
  # Holidays (if applicable)
  # holidays = generated_holidays  # Create with add_country_holidays()
  
  # Uncertainty intervals
  interval.width = 0.95,
  uncertainty.samples = 1000
)
future <- make_future_dataframe(model, periods = 298, include_history = T)
forecast <- predict(model, future)
forecast <- forecast[, c("ds", "yhat", "yhat_lower", "yhat_upper")]
forecast$pred <- ifelse(forecast$ds > max(uf_timegpt$ds), 1,0)
forecast$ds <- as.Date(forecast$ds)

ggplot(forecast, aes(x = ds, y = yhat)) +
  geom_ribbon(aes(ymin = yhat_lower, ymax = yhat_upper), 
              fill = "#9ecae1", alpha = 0.4) +
  geom_line(color = "#08519c", linewidth = 0.8) +
  geom_vline(xintercept = max(uf_timegpt$ds), color = "red", linetype = "dashed", linewidth=1) +
  scale_x_date(date_breaks = "6 months", date_labels = "%y %b") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Valores predichos (95%IC)",
      # subtitle = "March 10, 2025 - May 7, 2025",
       x = "Fecha",
       y = "Valor",
      # caption = "Source: Prophet Forecast Model"
      ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(color = "gray50"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    plot.caption = element_text(color = "gray30")
  )



# 1. Ensure dates are strictly Date objects
history_df <- uf_timegpt %>% mutate(ds = as.Date(ds))
fcst_df    <- timegpt_fcst %>% mutate(ds = as.Date(ds))

# 2. Plotting (Notice we don't bind_rows, we layer them)
ggplot() +
    # --- FORECAST LAYERS ---
    # 95% Confidence Interval
    geom_ribbon(data = fcst_df, 
                aes(x = ds, ymin = `TimeGPT-lo-95`, ymax = `TimeGPT-hi-95`), 
                fill = "#4B9CD3", alpha = 0.2) +
    # 80% Confidence Interval
    geom_ribbon(data = fcst_df, 
                aes(x = ds, ymin = `TimeGPT-lo-80`, ymax = `TimeGPT-hi-80`), 
                fill = "#4B9CD3", alpha = 0.3) +
    # Forecast Line (Map y to the 'TimeGPT' column)
    geom_line(data = fcst_df, 
              aes(x = ds, y = TimeGPT, color = "Pronóstico"), size = 1) +

    # --- HISTORY LAYER ---
    # History Line (Map y to the 'y' column)
    geom_line(data = history_df, 
              aes(x = ds, y = y, color = "Histórico"), size = 1) +

    # --- STYLING ---
    geom_vline(xintercept = max(history_df$ds), 
               linetype = "dashed", color = "red", size = 0.8) +
    scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
    scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
    scale_color_manual(name = "Leyenda", 
                       values = c("Histórico" = "black", "Pronóstico" = "#4B9CD3")) +
    labs(
        title = "Pronóstico de Serie Temporal con TimeGPT",
        subtitle = "Modelo: timegpt-1-long-horizon",
        x = "Fecha", y = "Valor"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(color = "gray50"),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      plot.caption = element_text(color = "gray30")
    )+
      theme(legend.position = "bottom")
```


`r paste0("La proyección de la UF a 298 días más ",tail(uf_serie_corrected$date2,1)+298," sería de: ",format(round(as.numeric(tail(forecast::forecast(fit_tbats, h=298)$mean,1)),0),big.mark=".", decimal.mark = ","), " pesos// Percentil 95% más alto proyectado: ",suppressWarnings(format(tail(round(as.numeric(unlist(strsplit(capture.output(forecast::forecast(fit_tbats, h=350)),"\\s{1,}"))),2),1),big.mark=".", decimal.mark = ",")))`

Según TimeGPT:
`r try({
    if (exists("timegpt_fcst") && nrow(timegpt_fcst) > 0) {
        paste0(
            "La proyección de la UF a 298 días más ",
            as.Date(max(unclass(timegpt_fcst$ds), na.rm = TRUE), "1970-01-01"), 
            " sería de: ",
            format(tail(timegpt_fcst, 1)$TimeGPT, big.mark = ".", decimal.mark = ","), 
            " pesos// Percentil 80% más alto proyectado: ",
            format(tail(timegpt_fcst, 1)[["TimeGPT-hi-80"]], big.mark = ".", decimal.mark = ","), 
            " pesos// Percentil 95% más alto proyectado: ",
            format(tail(timegpt_fcst, 1)[["TimeGPT-hi-95"]], big.mark = ".", decimal.mark = ",")
        )
    } else {
        "Proyección no disponible temporalmente"
    }
}, silent = TRUE)`

Según prophet:
`r paste0("La proyección de la UF a 298 días más ",
          max(forecast[forecast$pred==1,]$ds)," sería de: ",
          format(round(as.numeric(tail(forecast[forecast$pred==1,]$yhat,1)),0),big.mark=".", decimal.mark = ","), 
          " pesos// Percentil 95% más alto proyectado: ",
          format(round(as.numeric(tail(forecast[forecast$pred==1,]$yhat_upper,1)),0),big.mark=".", decimal.mark = ","))`

Ahora con un modelo ARIMA automático

<br>

```{r 1-5, echo=T, paged.print=TRUE,eval=T, error=T}
arima_optimal_uf = forecast::auto.arima(ts_uf_proy)

  autoplotly::autoplotly(forecast::forecast(arima_optimal_uf, h=298), ts.colour = "darkred",
           predict.colour = "blue", predict.linetype = "dashed")%>% 
  plotly::layout(showlegend = F, 
          yaxis = list(title = "Gastos"),
         xaxis = list(
    title="Fecha",
      ticktext = as.list(seq(from = as.Date("2018-01-01"), 
                                  to = as.Date("2018-01-01")+length(fit_tbats$fitted.values)+298, by = 90)), 
      tickvals = as.list(seq(from = as.numeric(as.Date("2018-01-01")), 
                             to = as.numeric(as.Date("2018-01-01"))+length(fit_tbats$fitted.values)+298, by = 90)),
      tickmode = "array",
    tickangle = 90
    ))

fr_fit_tbats_uf<-forecast::forecast(arima_optimal_uf, h=298)

```

::: controlly                                                      
```{r 1-5-2, echo=T, paged.print=TRUE,eval=T, error=T}
dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats)),variable) %>% dplyr::summarise(max=max(value)) %>% 
dplyr::right_join(dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats_uf)),variable) %>% dplyr::summarise(max=max(value)),by="variable") %>% 
  dplyr::mutate(variable=factor(variable,levels=c("Lo.95","Lo.80","Point.Forecast","Hi.80","Hi.95"))) %>% 
  dplyr::arrange(variable) %>% 
  knitr::kable(format="markdown", caption="Tabla. Estimación UF (de aquí a 298 días) según cálculos de gastos mensuales",
               col.names= c("Item","UF Proyectada (TBATS)","UF Proyectada (ARIMA)"))
```
:::

<br>

# 3. Gastos proyectados

Lo haré en base a 2 cálculos: el gasto semanal y el gasto mensual en base a mis gastos desde marzo de 2019. La primera proyección la hice añadiendo el precio del arriendo mensual y partiendo en 2 (porque es con yo y Tami). No se incluye el último mes.


```{r 2-gastos-proyectados-mensuales, echo=T, paged.print=TRUE,eval=T , echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE, caption="Figura. Proyección de gastos (incluyendo arriendo), Modelo TBATS"}
Gastos_casa_nvo <- readr::read_csv(as.character(path_sec),
                               col_names = c("Tiempo", "gasto", "fecha", "obs", "monto", "gastador",
                                             "link"),skip=1) %>% 
              dplyr::mutate(fecha= lubridate::parse_date_time(fecha, c("%d/%m/%Y"),exact=T)) %>% 
              dplyr::mutate(fecha_month=strftime(fecha, format = "%Y-%m")) %>%
              dplyr::mutate(day=as.Date(as.character(lubridate::floor_date(fecha, "day"))))

Gastos_casa_m <-
Gastos_casa_nvo %>% dplyr::group_by(fecha_month)%>%
              dplyr::summarise(gasto_total=(sum(monto)+500000)/1000,fecha=first(fecha))%>%
              data.frame()
  

uf_serie_corrected_m <-
uf_serie_corrected %>% dplyr::mutate(ano_m=paste0(anio,"-",sprintf("%02d",as.numeric(month)))) %>%  dplyr::group_by(ano_m)%>%
              dplyr::summarise(uf=(mean(value))/1000,fecha=first(date3))%>%
              data.frame() %>% 
  dplyr::filter(fecha>="2019-02-28")
#Error: Error in standardise_path(file) : object 'enlace_gastos' not found

ts_uf_serie_corrected_m<-
ts(data = uf_serie_corrected_m$uf[-length(uf_serie_corrected_m$uf)], 
   start = 1, 
   end = nrow(uf_serie_corrected_m), 
   frequency = 1,
   deltat = 1, ts.eps = getOption("ts.eps"))

ts_gastos_casa_m<-
ts(data = Gastos_casa_m$gasto_total[-length(Gastos_casa_m$gasto_total)], 
   start = 1, 
   end = nrow(Gastos_casa_m), 
   frequency = 1,
   deltat = 1, ts.eps = getOption("ts.eps"))

fit_tbats_m <- forecast::tbats(ts_gastos_casa_m)

seq_dates<-format(seq(as.Date("2019/03/01"), by = "month", length = dim(Gastos_casa_m)[1]+12), "%m\n'%y")

autplo2t<-
  autoplotly::autoplotly(forecast::forecast(fit_tbats_m, h=12), ts.colour = "darkred",
           predict.colour = "blue", predict.linetype = "dashed")%>% 
  plotly::layout(showlegend = F, 
          yaxis = list(title = "Gastos (en miles)+ Arriendo"),
         xaxis = list(
    title="Fecha",
      ticktext = as.list(seq_dates[seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)]), 
      tickvals = as.list(seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)),
      tickmode = "array"#"array"
    )) 

autplo2t
```

Ahora asumiendo un modelo ARIMA, e incluimos como regresor al precio de la UF.

```{r 2-5, echo=T, paged.print=TRUE,eval=T , echo=T, fig.align='center', fig.pos='H',cache=T, eval=T,message=FALSE, warning=FALSE,caption="Figura. Proyección de gastos mensuales de aquí a 12 meses (incluye arriendo), Modelo ARIMA y con regresor UF promedio mensual (desde 2018)"}
paste0("Optimo pero sin regresor")
arima_optimal = forecast::auto.arima(ts_gastos_casa_m)
arima_optimal

paste0("Optimo pero con regresor")
arima_optimal2 = forecast::auto.arima(ts_gastos_casa_m, xreg=as.numeric(ts_uf_serie_corrected_m[1:(length(Gastos_casa_m$gasto_total))]))
arima_optimal2

forecast_uf<-
cbind.data.frame(fecha=as.Date(seq(as.numeric(as.Date(uf_serie_corrected$date3[length(uf_serie_corrected$date3)])),(as.numeric(as.Date(uf_serie_corrected$date3[length(uf_serie_corrected$date3)]))+299),by=1), origin = "1970-01-01"),forecast::forecast(fit_tbats, h=300)) %>% 
  dplyr::mutate(ano_m=stringr::str_extract(fecha,".{7}")) %>% 
  dplyr::group_by(ano_m)%>%
              dplyr::summarise(uf=(mean(`Hi 95`,na.rm=T))/1000,fecha=first(fecha))%>%
            data.frame()
autplo2t2<-
  autoplotly::autoplotly(forecast::forecast(arima_optimal2,xreg=c(forecast_uf$uf[1],forecast_uf$uf), h=12), ts.colour = "darkred",
           predict.colour = "blue", predict.linetype = "dashed")%>% 
  plotly::layout(showlegend = F, 
          yaxis = list(title = "Gastos (en miles)"),
         xaxis = list(
    title="Fecha",
      ticktext = as.list(seq_dates[seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)]), 
      tickvals = as.list(seq(from = 1, to = (dim(Gastos_casa_m)[1]+12), by = 3)),
      tickmode = "array"#"array"
    )) 

autplo2t2
```

::: controlly
```{r 3, echo=T, paged.print=TRUE,eval=T}
fr_fit_tbats_m<-forecast::forecast(fit_tbats_m, h=12)
fr_fit_tbats_m2<-forecast::forecast(arima_optimal, h=12)
fr_fit_tbats_m3<-forecast::forecast(arima_optimal2, h=12,xreg=c(forecast_uf$uf[1],forecast_uf$uf))

dplyr::right_join(dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats_m3)),variable) %>% dplyr::summarise(max=max(value)), dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats_m2)),variable) %>% dplyr::summarise(max=max(value)),by="variable") %>% 
dplyr::right_join(dplyr::group_by(reshape2::melt(data.frame(fr_fit_tbats_m)),variable) %>% dplyr::summarise(max=max(value)),by="variable") %>% 
  dplyr::mutate(variable=factor(variable,levels=c("Lo.95","Lo.80","Point.Forecast","Hi.80","Hi.95"))) %>% 
  dplyr::arrange(variable) %>% 
  knitr::kable(format="markdown", caption="Estimación en miles de la plata a gastar en el futuro (de aquí a 12 meses) según cálculos de gastos mensuales",
               col.names= c("Item","Modelo ARIMA con regresor (UF)","Modelo ARIMA sin regresor","Modelo TBATS")) 
```
:::

<br>

# 4. Gastos mensuales (resumen manual)

::: controlly
```{r 4, echo=T, paged.print=TRUE,eval=T}
path_sec2<- paste0("https://docs.google.com/spreadsheets/d/",Sys.getenv("SUPERSECRET"),"/export?format=csv&id=",Sys.getenv("SUPERSECRET"),"&gid=847461368")

Gastos_casa_mensual_2022 <- readr::read_csv(as.character(path_sec2),
                #col_names = c("Tiempo", "gasto", "fecha", "obs", "monto", "gastador","link"),
                skip=0)

head(Gastos_casa_mensual_2022,5) %>% 
  knitr::kable("markdown",caption="Resumen mensual, primeras 5 observaciones")
```
:::

<br>

```{r linea-tiempo-gastador-gastos-manual, eval=T, echo=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Gasto Mensual"}
(
Gastos_casa_mensual_2022 %>% 
    reshape2::melt(id.var=c("n","mes_ano")) %>%
  dplyr::mutate(gastador=as.factor(variable)) %>% 
  dplyr::select(-variable) %>% 
 ggplot2::ggplot(aes(x = n, y = value, color=gastador)) +
  scale_color_manual(name="Gastador", values=c("red", "blue"))+
  geom_line(size=1) +
  #geom_vline(xintercept = as.Date("2019-06-24"),linetype = "dashed") +
  labs(y="Gastos (en miles)",x="Meses", subtitle="Azul= Tami; Rojo= Andrés") +
  ggtitle( "Gastos Mensuales (total manual)") +
  scale_y_continuous(labels = f <- function(x) paste0(x/1000)) + 
#  scale_color_manual(name = "Gastador", values= c("blue", "red"), labels = c("Tami", "Andrés")) +
#  scale_x_yearweek(breaks = "1 month", minor_breaks = "1 week", labels=date_format("%m/%y")) +
 # guides(color = F)+
  theme_custom() +
  theme(axis.text.x = element_text(vjust = 0.5,angle = 35)) +
  theme(
    panel.border = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_line(colour = "black")
    )
) %>% ggplotly()
```

```{r predictor-gastador-gastos-manual-timegpt, eval=T, echo=T, error=T, fig.height=8, fig.width=8, warning=FALSE, fig.align = "center", message=F, caption="Figura. Gasto Mensual, predicho"}
Gastos_casa_mensual_2022$mes_ano <- gsub("marzo", "Mar", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("abril", "Apr", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("mayo", "May", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("junio", "Jun", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("julio", "Jul", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("agosto", "Aug", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("septiembre", "Sep", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("octubre", "Oct", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("noviembre", "Nov", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("diciembre", "Dec", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("enero", "Jan", Gastos_casa_mensual_2022$mes_ano)
Gastos_casa_mensual_2022$mes_ano <- gsub("febrero", "Feb", Gastos_casa_mensual_2022$mes_ano)

Gastos_casa_mensual_2022<- dplyr::filter(Gastos_casa_mensual_2022, !is.na(Tami))

Gastos_casa_mensual_2022$mes_ano <- parse_date_time(Gastos_casa_mensual_2022$mes_ano, "%b_%Y")

Gastos_casa_mensual_2022$mes_ano <- as.Date(as.character(Gastos_casa_mensual_2022$mes_ano))

Gastos_casa_mensual_2022_timegpt <- Gastos_casa_mensual_2022 %>%
  mutate(value = Tami + Andrés) %>%
  rename(ds = mes_ano, y = value) %>%
  mutate(#ds= format(ds, "%Y-%m"),
         unique_id = "1") %>% #it is only one series
  select(unique_id, ds, y)

#Convertir la base de UF a mensual
uf_timegpt_my <- uf_serie_corrected %>%
  dplyr::rename(ds = date3, y = value) %>%
  dplyr::mutate(ds = format(ds, "%Y-%m-%d")) %>%
  dplyr::mutate(unique_id = "serie_1")%>%
  dplyr::select(unique_id, ds, y) %>%
  mutate(ds = ymd(ds)) %>%  # Convert 'ds' to Date
  mutate(month = month(ds), year = year(ds)) %>%  # Extract month and year
  group_by(month, year) %>%  # Group by month and year
  summarise(average_y = mean(y))%>%  # Calculate average y
  mutate(ds = as.Date(paste0(year,"-",month, "-01")))%>%
  ungroup()%>%
  select(ds, uf=average_y)

Gastos_casa_mensual_2022_timegpt_ex<-
Gastos_casa_mensual_2022_timegpt |> 
  dplyr::left_join(uf_timegpt_my, by=c("ds"="ds")) 

#Historical Exogenous Variables: These should be included in the input data immediately following the id_col, ds, and y columns
gastos_timegpt_fcst <- nixtlar::nixtla_client_forecast(
  Gastos_casa_mensual_2022_timegpt_ex,
  h = 12,
  freq = "M",  # Monthly frequency
  add_history = F,
  level = c(80, 95),
  model = "timegpt-1",#"timegpt-1-long-horizon",
  clean_ex_first = TRUE
)

# Convert 'ds' to Date format in both tables
Gastos_casa_mensual_2022_timegpt_corr <- Gastos_casa_mensual_2022_timegpt %>%
  mutate(ds = as.Date(paste0(ds, "-01")))  # Add day to make it a complete date

gastos_timegpt_fcst <- gastos_timegpt_fcst %>%
  mutate(ds = as.Date(paste0(ds, "-01")))  # Add day to make it a complete date

# Combine historical and forecast data
full_data_gastos <- bind_rows(
  Gastos_casa_mensual_2022_timegpt_corr %>% mutate(type = "Histórico"),
  gastos_timegpt_fcst %>% mutate(type = "Pronóstico")
)

full_data_gastos |> 
  dplyr::mutate(y= ifelse(is.na(y),TimeGPT/1000, y/1000)) |> 
# Visualize results
ggplot(aes(x = ds, y = y)) +
  geom_ribbon(aes(ymin = `TimeGPT-lo-95`/1000, ymax = `TimeGPT-hi-95`/1000),
              fill = "#4B9CD3", alpha = 0.2) +
  geom_ribbon(aes(ymin = `TimeGPT-lo-80`/1000, ymax = `TimeGPT-hi-80`/1000),
              fill = "#4B9CD3", alpha = 0.3) +
  geom_line(aes(color = type), linewidth = 1.5) +
  geom_vline(xintercept = max(filter(full_data_gastos, type == "Histórico")$ds),
             linetype = "dashed", color = "red", linewidth = 0.8) +
  scale_x_date(
    date_breaks = "3 months",
    date_labels = "%b %Y"
  ) +
  scale_y_continuous(
    name = "Gastos Totales",
    labels = scales::comma#,
    # breaks = pretty(full_data_gastos$y, n = 10),
    # expand = expansion(mult = c(0.05, 0.05))
  ) +
  scale_color_manual(
    name = "Leyenda",
    values = c("Histórico" = "black", "Pronóstico" = "#4B9CD3")
  ) +
  labs(
    title = "Pronóstico de Gastos Mensuales (TimeGPT, ajustando por UF promedio mensual)",
    subtitle = "Intervalos de confianza al 80% (más oscuro) y 95% (más claro)",
    x = "Fecha",
    y = "Gastos Totales",
    color = "Leyenda"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

<br>

# Session Info

```{r session_info, echo=T, paged.print=TRUE}
Sys.getenv("R_LIBS_USER")
sessionInfo()
#save.image("__analisis.RData")

sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Packages')),
      options=list(
initComplete = htmlwidgets::JS(
        "function(settings, json) {",
        "$(this.api().tables().body()).css({
            'font-family': 'Helvetica Neue',
            'font-size': '50%', 
            'code-inline-font-size': '15%', 
            'white-space': 'nowrap',
            'line-height': '0.75em',
            'min-height': '0.5em'
            });",#;
        "}")))
```
